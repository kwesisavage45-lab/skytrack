<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkyTrack Pro | Elite Flight Intelligence</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Libre+Barcode+128&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <style>
        :root {
            --bg: #0f172a;
            --card: rgba(30, 41, 59, 0.7);
            --text: #f8fafc;
            --text-dim: #94a3b8;
            --accent: #38bdf8;
            --nav-bg: rgba(15, 23, 42, 0.9);
            --border: rgba(255, 255, 255, 0.1);
            --footer-bg: #0b1120;
        }

        [data-theme="light"] {
            --bg: #f8fafc;
            --card: rgba(255, 255, 255, 0.9);
            --text: #0f172a;
            --text-dim: #475569;
            --accent: #0284c7;
            --nav-bg: rgba(248, 250, 252, 0.9);
            --border: rgba(0, 0, 0, 0.1);
            --footer-bg: #e2e8f0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; transition: all 0.3s ease; }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            line-height: 1.6;
        }

        .hidden { display: none !important; }

        nav {
            position: fixed; top: 0; width: 100%; z-index: 2000;
            background: var(--nav-bg);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--border);
            padding: 1rem 8%;
            display: flex; justify-content: space-between; align-items: center;
        }

        .logo { font-size: 1.6rem; font-weight: 800; color: var(--accent); text-decoration: none; display: flex; align-items: center; gap: 10px; }
        .nav-content { display: flex; align-items: center; gap: 3rem; }
        .nav-links { display: flex; gap: 2.5rem; list-style: none; }
        .nav-links a { text-decoration: none; color: var(--text); font-weight: 500; font-size: 0.95rem; position: relative; padding: 5px 0; }
        .nav-links a::after { content: ''; position: absolute; bottom: 0; left: 0; width: 0; height: 2px; background: var(--accent); transition: width 0.3s ease; }
        .nav-links a:hover::after { width: 100%; }
        .nav-links a:hover { color: var(--accent); }
        .nav-actions { display: flex; align-items: center; gap: 1.5rem; }

        .btn-auth {
            background: var(--accent);
            color: #fff;
            padding: 0.7rem 1.5rem;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 15px rgba(56, 189, 248, 0.3);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-auth:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(56, 189, 248, 0.5); }

        #theme-toggle { background: none; border: none; color: var(--text); cursor: pointer; font-size: 1.3rem; }

        section { min-height: 100vh; padding: 100px 8% 60px; display: flex; flex-direction: column; }
        .hero { justify-content: center; align-items: center; text-align: center; }
        .hero h1 { font-size: clamp(2.2rem, 6vw, 4.5rem); font-weight: 800; line-height: 1.1; margin-bottom: 1.5rem; }
        .hero h1 span { color: var(--accent); }
        .hero p { font-size: 1.1rem; color: var(--text-dim); max-width: 700px; margin-bottom: 2.5rem; }

        .hero-btn-group {
            display: flex; gap: 12px; justify-content: center;
            width: 100%; max-width: 420px; margin: 0 auto;
        }
        .hero-btn-group .btn-auth { flex: 1; white-space: nowrap; padding: 1rem 1.2rem; }

        .dashboard-container { max-width: 800px; margin: 0 auto; width: 100%; }
        .glass-card { background: var(--card); padding: 2rem; border-radius: 24px; border: 1px solid var(--border); backdrop-filter: blur(10px); }
        
        .history-section { margin-top: 30px; }
        .history-card { background: var(--card); padding: 1rem; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .history-info { display: flex; flex-direction: column; }
        .history-id { color: var(--accent); font-weight: 800; font-size: 0.9rem; }
        .history-route { font-size: 0.8rem; font-weight: 600; }

        .trip-type-selector { display: flex; gap: 15px; margin-bottom: 20px; }
        .radio-group { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; cursor: pointer; }
        
        .grid-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .input-group { display: flex; flex-direction: column; gap: 8px; text-align: left; }
        .input-group label { font-size: 0.8rem; font-weight: 600; color: var(--accent); }
        .input-group input, .input-group select { 
            padding: 12px; border-radius: 12px; border: 1px solid var(--border); 
            background: rgba(0,0,0,0.2); color: white; outline: none; width: 100%;
        }
        [data-theme="light"] .input-group input, [data-theme="light"] .input-group select { background: #fff; color: #000; }

        .time-wrapper { display: flex; gap: 8px; }
        .time-wrapper input { flex: 2; }
        .time-wrapper select { flex: 1; }

        .info-notice-box {
            margin-top: 20px; padding: 15px; border: 1px dashed var(--accent); background: rgba(56, 189, 248, 0.05);
            border-radius: 12px; display: flex; align-items: flex-start; gap: 12px; transform: skewX(-2deg);
        }
        .info-notice-box i { color: var(--accent); margin-top: 3px; font-size: 0.9rem; }
        .info-notice-box p { font-size: 0.8rem; line-height: 1.4; color: var(--text-dim); margin-bottom: 0; text-align: left; font-style: italic; }

        .ticket-wrapper { margin-top: 30px; animation: slideUp 0.5s ease; width: 100%; }
        .ticket-visual {
            width: 100%; max-width: 750px; margin: 0 auto; background: #fff; color: #1a1a1a; 
            border-radius: 20px; display: flex; overflow: hidden; box-shadow: 0 30px 60px rgba(0,0,0,0.4);
        }
        .ticket-main { flex: 2; padding: 30px; border-right: 2px dashed #e2e8f0; position: relative; }
        .ticket-stub { flex: 0.8; padding: 30px; background: #f8fafc; display: flex; flex-direction: column; justify-content: space-between; }
        
        .airline-branding { display: flex; align-items: center; gap: 15px; margin-bottom: 30px; }
        .airline-logo { height: 40px; width: 40px; object-fit: contain; }
        .airline-name { font-weight: 800; font-size: 1.4rem; letter-spacing: -1px; }

        .pass-row { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .pass-label { font-size: 0.65rem; color: #64748b; font-weight: 800; text-transform: uppercase; display: block; }
        .pass-val { font-size: 1.1rem; font-weight: 700; color: #0f172a; }
        .ticket-id-val { color: var(--accent); font-weight: 800; }
        .barcode { font-family: 'Libre Barcode 128', cursive; font-size: 3rem; margin-top: 10px; }

        footer { background: var(--footer-bg); padding: 5rem 8% 2rem; border-top: 1px solid var(--border); }
        .footer-container { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 4rem; margin-bottom: 4rem; }
        .footer-brand h2 { color: var(--accent); margin-bottom: 1rem; font-weight: 800; }
        .footer-brand p { color: var(--text-dim); font-size: 0.9rem; max-width: 300px; }
        .footer-links h4 { color: var(--text); margin-bottom: 1.5rem; font-weight: 700; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px; }
        .footer-links ul { list-style: none; }
        .footer-links ul li { margin-bottom: 0.8rem; }
        .footer-links ul li a { text-decoration: none; color: var(--text-dim); font-size: 0.9rem; }
        .footer-links ul li a:hover { color: var(--accent); }
        .footer-bottom { padding-top: 2rem; border-top: 1px solid var(--border); text-align: center; font-size: 0.85rem; color: var(--text-dim); }

        .mobile-toggle { display: none; font-size: 1.5rem; cursor: pointer; }

        @media (max-width: 768px) {
            nav { padding: 1rem 5%; }
            .nav-content { 
                position: fixed; top: 70px; left: -100%; width: 100%; height: calc(100vh - 70px); 
                background: var(--nav-bg); flex-direction: column; justify-content: center; z-index: 1000; 
                transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); padding-bottom: 100px;
            }
            .nav-content.active { left: 0; }
            .nav-links { flex-direction: column; align-items: center; gap: 2rem; }
            .mobile-toggle { display: block; }
            section { padding: 100px 5% 40px; }
            .ticket-visual { flex-direction: column; }
            .footer-container { grid-template-columns: 1fr; gap: 2rem; }
            /* ‚îÄ‚îÄ History cards mobile ‚îÄ‚îÄ */
            .hist-card { border-radius:14px !important; }
            .hist-card .hist-actions { flex-direction:column !important; }
            .hist-card .hist-actions button { width:100% !important; justify-content:center !important; }
        }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* ‚îÄ‚îÄ Price Section ‚îÄ‚îÄ */
        .price-result-box {
            background: rgba(34,197,94,0.07); border: 1px solid #22c55e; border-radius: 14px;
            padding: 14px 16px; margin-bottom: 6px; animation: slideUp 0.3s ease;
        }

        /* ‚îÄ‚îÄ Soft Modal Overlay ‚îÄ‚îÄ */
        .sky-modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9000;
            display: flex; align-items: center; justify-content: center; padding: 20px;
            animation: fadeInModal 0.25s ease;
        }
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
        .sky-modal {
            background: var(--card); border-radius: 24px; border: 1px solid var(--border);
            padding: 2.5rem; max-width: 440px; width: 100%; text-align: center;
            box-shadow: 0 30px 80px rgba(0,0,0,0.3); animation: popIn 0.3s cubic-bezier(0.34,1.56,0.64,1);
            backdrop-filter: blur(20px);
        }
        @keyframes popIn { from { opacity: 0; transform: scale(0.85); } to { opacity: 1; transform: scale(1); } }
        .sky-modal .modal-icon { font-size: 3.5rem; margin-bottom: 1rem; display: block; }
        .sky-modal h3 { font-size: 1.4rem; font-weight: 800; margin-bottom: 0.5rem; }
        .sky-modal p { color: var(--text-dim); font-size: 0.9rem; line-height: 1.6; margin-bottom: 1.5rem; }
        .sky-modal .modal-btn { 
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            padding: 0.8rem 2rem; border-radius: 50px; border: none; font-weight: 700; font-size: 0.9rem; cursor: pointer; 
            transition: transform 0.2s, box-shadow 0.2s; text-decoration: none;
        }
        .sky-modal .modal-btn:hover { transform: translateY(-2px); }
        .sky-modal .modal-btn-primary { background: var(--accent); color: #fff; box-shadow: 0 4px 15px rgba(56,189,248,0.35); }
        .sky-modal .modal-btn-danger { background: #ef4444; color: #fff; box-shadow: 0 4px 15px rgba(239,68,68,0.35); }
        .sky-modal .modal-btn-ghost { background: transparent; color: var(--text-dim); border: 1px solid var(--border); }

        .transit-toggle-row { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding: 14px; background: rgba(56,189,248,0.05); border: 1px dashed var(--border); border-radius: 12px; }
        .transit-toggle-row label { font-size: 0.85rem; font-weight: 600; color: var(--text); cursor: pointer; }
        .transit-toggle-row input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--accent); cursor: pointer; }
        .transit-fields { margin-bottom: 20px; animation: slideUp 0.3s ease; }
        .cancel-flight-btn { background: #ef4444 !important; }
        .cancel-flight-btn:hover { background: #dc2626 !important; box-shadow: 0 6px 20px rgba(239,68,68,0.4) !important; }

        /* ‚îÄ‚îÄ Airport selector ‚îÄ‚îÄ */
        .airport-selector-wrap { margin-top: 10px; }
        .airport-status { font-size: 0.75rem; color: var(--text-dim); display: flex; align-items: center; gap: 6px; min-height: 18px; margin-bottom: 5px; }
        .dot-spin { width:10px; height:10px; border:2px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:_spin 0.7s linear infinite; display:inline-block; flex-shrink:0; }
        @keyframes _spin { to { transform:rotate(360deg); } }
        .airport-select {
            width:100%; padding:11px 32px 11px 12px; border-radius:12px;
            border:1.5px solid var(--accent); background:rgba(56,189,248,0.07);
            color:var(--text); outline:none; font-size:0.85rem; font-weight:600;
            cursor:pointer; appearance:none;
            background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='11' height='11' viewBox='0 0 24 24' fill='none' stroke='%2338bdf8' stroke-width='3'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat:no-repeat; background-position:right 12px center;
        }
        [data-theme="light"] .airport-select { background-color:#f0f9ff; color:#0f172a; border-color:#0284c7; }
        .airport-select option { background:var(--bg); color:var(--text); padding:6px; }
        .airport-warn { font-size:0.73rem; color:#f59e0b; font-style:italic; margin-top:4px; }
        .airport-chip { display:inline-flex; align-items:center; gap:5px; background:var(--accent); color:#fff; font-size:0.68rem; font-weight:800; padding:3px 10px; border-radius:20px; margin-top:5px; letter-spacing:1px; }

        /* ‚îÄ‚îÄ Custom Airport Entry ‚îÄ‚îÄ */
        .custom-apt-toggle {
            display:inline-flex; align-items:center; gap:5px;
            background:transparent; border:1.5px solid var(--accent);
            color:var(--accent); font-size:0.7rem; font-weight:700;
            padding:3px 10px; border-radius:20px; cursor:pointer;
            transition:all 0.2s; letter-spacing:0.3px;
        }
        .custom-apt-toggle:hover, .custom-apt-toggle.active {
            background:var(--accent); color:#fff;
        }
        .custom-apt-box {
            margin-top:10px; padding:14px; background:rgba(56,189,248,0.06);
            border:1.5px dashed var(--accent); border-radius:14px;
            animation: slideUp 0.25s ease;
        }
        .custom-apt-row {
            display:flex; align-items:flex-end; gap:10px; flex-wrap:wrap;
        }
        .custom-apt-row > div { display:flex; flex-direction:column; gap:5px; flex:1; min-width:80px; }
        .custom-apt-label { font-size:0.68rem; font-weight:700; color:var(--accent); text-transform:uppercase; letter-spacing:0.8px; }
        .custom-apt-input {
            padding:9px 11px; border-radius:10px; border:1.5px solid var(--border);
            background:rgba(0,0,0,0.12); color:var(--text); outline:none;
            font-size:0.85rem; font-family:inherit; width:100%;
            transition:border-color 0.2s;
        }
        [data-theme="light"] .custom-apt-input { background:#fff; color:#0f172a; }
        .custom-apt-input:focus { border-color:var(--accent); }
        .custom-apt-confirm {
            padding:9px 16px; background:var(--accent); color:#fff;
            border:none; border-radius:10px; font-weight:800; font-size:0.8rem;
            cursor:pointer; white-space:nowrap; align-self:flex-end;
            transition:transform 0.15s, box-shadow 0.15s;
        }
        .custom-apt-confirm:hover { transform:translateY(-1px); box-shadow:0 4px 12px rgba(56,189,248,0.35); }
        .airport-chip-custom { background:#f59e0b !important; }
    </style>
</head>
<body>

    <nav>
        <a href="#" class="logo" onclick="toggleDashboard(false)">
            <i class="fas fa-paper-plane"></i> SkyTrack Pro
        </a>
        
        <div class="nav-content" id="navContent">
            <ul class="nav-links">
                <li><a href="#" onclick="toggleDashboard(false)">Home</a></li>
                <li><a href="about.html">About</a></li>
                <li><a href="contact.html">Contact</a></li>
                <li><a href="#" onclick="showTrackSection()">Track Flight</a></li>
                <li><a href="#" onclick="showHistorySection()" id="historyNavLink" style="display:none;">Flight History</a></li>
                <li><a href="track.html">Live Tracker</a></li>
            </ul>
            <div class="nav-actions">
                    <span id="navUserName" style="display:none; font-size:0.85rem; font-weight:700; color:var(--accent);"></span>
                    <button onclick="handleAuthClick()" class="btn-auth" id="navActionBtn">Get Started</button>
            </div>
        </div>

        <div style="display: flex; align-items: center; gap: 15px;">
            <button id="theme-toggle"><i class="fas fa-moon"></i></button>
            <i class="fas fa-bars mobile-toggle" id="menuBtn"></i>
        </div>
    </nav>

    <section class="hero" id="heroSection">
        <h1>Your Journey <br><span>In Real Time.</span></h1>
        <p>The definitive command center for high-fidelity transit monitoring. Generate identity assets through your SkyTrack ID, secure your terminal access, and oversee your simulated flight path in real-time. Track your journey like a pro.</p>
        <div class="hero-btn-group">
            <button onclick="toggleDashboard(true)" class="btn-auth">Create Ticket</button>
            <button onclick="showTrackSection()" class="btn-auth" style="background: transparent; border: 1px solid var(--accent); color: var(--text);">Track Flight</button>
        </div>
    </section>

    <!-- ‚îÄ‚îÄ TRACK FLIGHT SECTION ‚îÄ‚îÄ -->
    <section class="hidden" id="trackSection" style="justify-content:center; align-items:center;">
        <div style="max-width:680px; width:100%; margin:0 auto;">
            <button onclick="showHeroSection()" style="background:none; border:none; color:var(--accent); cursor:pointer; margin-bottom:20px; font-weight:600; display:flex; align-items:center; gap:8px;">
                <i class="fas fa-arrow-left"></i> Back to Home
            </button>
            <div class="glass-card" style="text-align:center;">
                <div style="font-size:3rem; margin-bottom:12px;">‚úàÔ∏è</div>
                <h2 style="font-weight:900; margin-bottom:8px; font-size:1.8rem;">Track Your Flight</h2>
                <p style="color:var(--text-dim); margin-bottom:28px; font-size:0.95rem;">Enter your SkyTrack ID to view full flight details and live progress</p>
                <div style="position:relative; margin-bottom:20px;">
                    <input type="text" id="heroTrackInput" placeholder="e.g. ST-ABC12" 
                        style="width:100%; padding:18px 60px 18px 20px; border-radius:50px; border:2px solid var(--border); background:rgba(0,0,0,0.05); color:var(--text); font-size:1.1rem; text-align:center; text-transform:uppercase; outline:none; font-family:inherit; letter-spacing:2px;"
                        oninput="this.value=this.value.toUpperCase()"
                        onkeydown="if(event.key==='Enter') heroTrackSearch()">
                </div>
                <button onclick="heroTrackSearch()" class="btn-auth" style="width:100%; padding:1rem; font-size:1rem; border-radius:50px;">
                    <i class="fas fa-search" style="margin-right:8px;"></i> Search Flight
                </button>
                <div id="heroTrackResult" style="margin-top:24px; text-align:left;"></div>
                <div id="heroTrackHistory" style="margin-top:28px; text-align:left;"></div>
            </div>
        </div>
    </section>

    <!-- ‚îÄ‚îÄ FLIGHT HISTORY SECTION ‚îÄ‚îÄ -->
    <section class="hidden" id="historySection" style="justify-content:center; align-items:center;">
        <div style="max-width:760px; width:100%; margin:0 auto;">
            <button onclick="showHeroSection()" style="background:none; border:none; color:var(--accent); cursor:pointer; margin-bottom:20px; font-weight:600; display:flex; align-items:center; gap:8px;">
                <i class="fas fa-arrow-left"></i> Back to Home
            </button>
            <div class="glass-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
                    <h2 style="font-weight:900; margin:0;"><i class="fas fa-history" style="color:var(--accent); margin-right:10px;"></i>Flight History</h2>
                    <button onclick="refreshHistorySection()" class="btn-auth" style="padding:0.5rem 1.2rem; font-size:0.8rem;"><i class="fas fa-sync-alt"></i> Refresh</button>
                </div>
                <div id="fullHistoryList"></div>
            </div>
        </div>
    </section>

    <section class="hidden" id="dashboardSection">
        <div class="dashboard-container">
            <button onclick="toggleDashboard(false)" style="background:none; border:none; color:var(--accent); cursor:pointer; margin-bottom:15px; font-weight:600;">
                <i class="fas fa-arrow-left"></i> Back to Home
            </button>
            
            <div class="glass-card">
                <h2 style="margin-bottom: 20px;">Flight Dashboard</h2>
                
                <div class="input-group" style="margin-bottom: 20px;">
                    <label>Passenger Full Name</label>
                    <input type="text" id="fullName" placeholder="e.g. Alexandra Reed">
                </div>

                <div class="trip-type-selector">
                    <label class="radio-group"><input type="radio" name="trip" value="one" checked onclick="toggleReturnDate(false)"> One-way</label>
                    <label class="radio-group"><input type="radio" name="trip" value="round" onclick="toggleReturnDate(true)"> Round Trip</label>
                </div>

                <!-- City + Country for map geocoding accuracy -->
                <div class="grid-inputs">
                    <div class="input-group">
                        <label>From ‚Äî City</label>
                        <input type="text" id="fromCity" placeholder="e.g. London" oninput="scheduleAirportFetch('from')">
                    </div>
                    <div class="input-group">
                        <label>From ‚Äî Country</label>
                        <input type="text" id="fromCountry" placeholder="e.g. United Kingdom" oninput="scheduleAirportFetch('from')">
                    </div>
                </div>
                <div class="input-group" id="fromAirportWrap" style="margin-bottom:16px; display:none;">
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:4px;">
                        <label style="margin-bottom:0;">Departure Airport</label>
                        <button type="button" class="custom-apt-toggle" onclick="toggleCustomAirport('from')">
                            <i class="fas fa-pen" style="font-size:0.65rem;"></i> Custom
                        </button>
                    </div>
                    <div class="airport-status" id="fromAirportStatus"></div>
                    <select class="airport-select" id="fromAirportSelect" onchange="onAirportChange('from')">
                        <option value="">‚Äî select airport ‚Äî</option>
                    </select>
                    <div class="airport-warn hidden" id="fromAirportWarn"></div>
                    <div id="fromAirportChip"></div>
                    <!-- Custom Airport Entry -->
                    <div class="custom-apt-box hidden" id="fromCustomBox">
                        <div class="custom-apt-row">
                            <div>
                                <label class="custom-apt-label">IATA Code</label>
                                <input type="text" id="fromCustomCode" class="custom-apt-input" placeholder="e.g. LHR" maxlength="4" oninput="this.value=this.value.toUpperCase()">
                            </div>
                            <div style="flex:2;">
                                <label class="custom-apt-label">Airport Name</label>
                                <input type="text" id="fromCustomName" class="custom-apt-input" placeholder="e.g. Heathrow Airport">
                            </div>
                            <button type="button" class="custom-apt-confirm" onclick="confirmCustomAirport('from')">‚úì Set</button>
                        </div>
                    </div>
                </div>

                <div class="grid-inputs">
                    <div class="input-group">
                        <label>To ‚Äî City</label>
                        <input type="text" id="toCity" placeholder="e.g. New York" oninput="scheduleAirportFetch('to')">
                    </div>
                    <div class="input-group">
                        <label>To ‚Äî Country</label>
                        <input type="text" id="toCountry" placeholder="e.g. United States" oninput="scheduleAirportFetch('to')">
                    </div>
                </div>
                <div class="input-group" id="toAirportWrap" style="margin-bottom:16px; display:none;">
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:4px;">
                        <label style="margin-bottom:0;">Arrival Airport</label>
                        <button type="button" class="custom-apt-toggle" onclick="toggleCustomAirport('to')">
                            <i class="fas fa-pen" style="font-size:0.65rem;"></i> Custom
                        </button>
                    </div>
                    <div class="airport-status" id="toAirportStatus"></div>
                    <select class="airport-select" id="toAirportSelect" onchange="onAirportChange('to')">
                        <option value="">‚Äî select airport ‚Äî</option>
                    </select>
                    <div class="airport-warn hidden" id="toAirportWarn"></div>
                    <div id="toAirportChip"></div>
                    <div class="custom-apt-box hidden" id="toCustomBox">
                        <div class="custom-apt-row">
                            <div>
                                <label class="custom-apt-label">IATA Code</label>
                                <input type="text" id="toCustomCode" class="custom-apt-input" placeholder="e.g. JFK" maxlength="4" oninput="this.value=this.value.toUpperCase()">
                            </div>
                            <div style="flex:2;">
                                <label class="custom-apt-label">Airport Name</label>
                                <input type="text" id="toCustomName" class="custom-apt-input" placeholder="e.g. JFK International">
                            </div>
                            <button type="button" class="custom-apt-confirm" onclick="confirmCustomAirport('to')">‚úì Set</button>
                        </div>
                    </div>
                </div>

                <div class="grid-inputs">
                    <div class="input-group">
                        <label>Departure Date</label>
                        <input type="date" id="travelDate">
                    </div>
                    <div class="input-group">
                        <label>Departure Time</label>
                        <div class="time-wrapper">
                            <input type="text" id="depTime" placeholder="HH:MM" maxlength="5" class="time-mask">
                            <select id="depAMPM"><option>AM</option><option>PM</option></select>
                        </div>
                    </div>
                </div>

                <div class="grid-inputs">
                    <div class="input-group">
                        <label>Estimated Arrival Time</label>
                        <div class="time-wrapper">
                            <input type="text" id="arrTime" placeholder="HH:MM" maxlength="5" class="time-mask">
                            <select id="arrAMPM"><option>AM</option><option>PM</option></select>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Flight Class</label>
                        <select id="flightClass">
                            <option value="Economy Class">Economy Class</option>
                            <option value="Basic Economy">Basic Economy</option>
                            <option value="Premium Economy">Premium Economy</option>
                            <option value="Business Class">Business Class</option>
                            <option value="First Class">First Class</option>
                        </select>
                    </div>
                </div>

                <div class="input-group" style="margin-bottom: 20px;">
                    <label>Airline</label>
                    <select id="airlineSelect" onchange="handleAirlineChange(this.value)">
                        <optgroup label="üá∫üá∏ US Carriers">
                            <option value="American Airlines">American Airlines</option>
                            <option value="Delta Air Lines">Delta Air Lines</option>
                            <option value="United Airlines">United Airlines</option>
                            <option value="Southwest Airlines">Southwest Airlines</option>
                            <option value="Spirit Airlines">Spirit Airlines</option>
                            <option value="Frontier Airlines">Frontier Airlines</option>
                            <option value="JetBlue Airways">JetBlue Airways</option>
                            <option value="Alaska Airlines">Alaska Airlines</option>
                        </optgroup>
                        <optgroup label="üåç International">
                            <option value="Emirates">Emirates</option>
                            <option value="Qatar Airways">Qatar Airways</option>
                            <option value="Lufthansa">Lufthansa</option>
                            <option value="British Airways">British Airways</option>
                            <option value="Air France">Air France</option>
                            <option value="KLM">KLM</option>
                            <option value="Turkish Airlines">Turkish Airlines</option>
                            <option value="Singapore Airlines">Singapore Airlines</option>
                            <option value="Etihad Airways">Etihad Airways</option>
                            <option value="Air Canada">Air Canada</option>
                            <option value="Ryanair">Ryanair</option>
                            <option value="EasyJet">EasyJet</option>
                            <option value="Vueling">Vueling</option>
                            <option value="Iberia">Iberia</option>
                            <option value="Cathay Pacific">Cathay Pacific</option>
                            <option value="Japan Airlines">Japan Airlines</option>
                            <option value="ANA">ANA</option>
                            <option value="Korean Air">Korean Air</option>
                            <option value="Air Arabia">Air Arabia</option>
                            <option value="flydubai">flydubai</option>
                        </optgroup>
                        <optgroup label="üåç African Carriers">
                            <option value="Ethiopian Airlines">Ethiopian Airlines</option>
                            <option value="Kenya Airways">Kenya Airways</option>
                            <option value="RwandAir">RwandAir</option>
                            <option value="Arik Air">Arik Air</option>
                            <option value="Africa World Airlines">Africa World Airlines</option>
                        </optgroup>
                        <option value="custom">‚úè Other (Input Custom)</option>
                    </select>
                    <input type="text" id="customAirline" class="hidden" placeholder="Enter Airline Name" style="margin-top:10px;" oninput="scheduleLogoFetch()">
                </div>

                <div id="returnGroup" class="input-group hidden" style="margin-bottom: 20px;">
                    <label>Return Date</label>
                    <input type="date" id="returnDate">
                </div>

                <!-- Transit Section -->
                <div class="transit-toggle-row">
                    <input type="checkbox" id="hasTransit" onchange="toggleTransit(this.checked)">
                    <label for="hasTransit"><i class="fas fa-route" style="color:var(--accent); margin-right:6px;"></i> Will there be a transit stop in your travel?</label>
                </div>
                <div id="transitFields" class="transit-fields hidden">
                    <div class="grid-inputs">
                        <div class="input-group">
                            <label>Transit ‚Äî City <span style="color:#ef4444;">*</span></label>
                            <input type="text" id="transitCity" placeholder="e.g. Dubai" oninput="scheduleAirportFetch('transit')">
                        </div>
                        <div class="input-group">
                            <label>Transit ‚Äî Country <span style="color:#ef4444;">*</span></label>
                            <input type="text" id="transitCountry" placeholder="e.g. United Arab Emirates" oninput="scheduleAirportFetch('transit')">
                        </div>
                    </div>
                    <div class="input-group" id="transitAirportWrap" style="margin-bottom:16px; display:none;">
                        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:4px;">
                            <label style="margin-bottom:0;">Transit Airport</label>
                            <button type="button" class="custom-apt-toggle" onclick="toggleCustomAirport('transit')">
                                <i class="fas fa-pen" style="font-size:0.65rem;"></i> Custom
                            </button>
                        </div>
                        <div class="airport-status" id="transitAirportStatus"></div>
                        <select class="airport-select" id="transitAirportSelect" onchange="onAirportChange('transit')">
                            <option value="">‚Äî select airport ‚Äî</option>
                        </select>
                        <div class="airport-warn hidden" id="transitAirportWarn"></div>
                        <div id="transitAirportChip"></div>
                        <div class="custom-apt-box hidden" id="transitCustomBox">
                            <div class="custom-apt-row">
                                <div>
                                    <label class="custom-apt-label">IATA Code</label>
                                    <input type="text" id="transitCustomCode" class="custom-apt-input" placeholder="e.g. DXB" maxlength="4" oninput="this.value=this.value.toUpperCase()">
                                </div>
                                <div style="flex:2;">
                                    <label class="custom-apt-label">Airport Name</label>
                                    <input type="text" id="transitCustomName" class="custom-apt-input" placeholder="e.g. Dubai International">
                                </div>
                                <button type="button" class="custom-apt-confirm" onclick="confirmCustomAirport('transit')">‚úì Set</button>
                            </div>
                        </div>
                    </div>
                    <div class="grid-inputs">
                        <div class="input-group">
                            <label>Transit Arrival Time</label>
                            <div class="time-wrapper">
                                <input type="text" id="transitArrTime" placeholder="HH:MM" maxlength="5" class="time-mask">
                                <select id="transitArrAMPM"><option>AM</option><option>PM</option></select>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Transit Layover Duration</label>
                            <select id="transitDuration" onchange="handleLayoverChange(this.value)">
                                <option value="30">30 minutes</option>
                                <option value="45">45 minutes</option>
                                <option value="60">1 hour</option>
                                <option value="90">1.5 hours</option>
                                <option value="120" selected>2 hours</option>
                                <option value="180">3 hours</option>
                                <option value="240">4 hours</option>
                                <option value="300">5 hours</option>
                                <option value="360">6 hours</option>
                                <option value="custom">Custom time‚Ä¶</option>
                            </select>
                            <div id="customLayoverWrap" class="hidden" style="margin-top:10px; display:flex; gap:8px; align-items:center;">
                                <input type="number" id="customLayoverVal" placeholder="e.g. 90" min="1" style="flex:2; padding:12px; border-radius:12px; border:1px solid var(--border); background:rgba(0,0,0,0.2); color:white; outline:none;">
                                <select id="customLayoverUnit" style="flex:1; padding:12px; border-radius:12px; border:1px solid var(--border); background:rgba(0,0,0,0.2); color:white; outline:none;">
                                    <option value="minutes">min</option>
                                    <option value="hours">hrs</option>
                                </select>
                            </div>
                            <style>[data-theme="light"] #customLayoverWrap input,[data-theme="light"] #customLayoverWrap select{background:#fff;color:#000;}</style>
                        </div>
                    </div>
                </div>

                <!-- ‚ïê‚ïê‚ïê FLIGHT PRICE SECTION ‚ïê‚ïê‚ïê -->
                <div class="price-section" id="priceSectionWrap" style="margin-top:20px;">
                    <label style="font-size:0.8rem; font-weight:700; color:var(--accent); display:block; margin-bottom:10px;">
                        <i class="fas fa-tag" style="margin-right:5px;"></i>TICKET PRICE <span style="font-weight:400; color:var(--text-dim);">(optional)</span>
                    </label>
                    <div class="custom-apt-box" style="margin:0; padding:14px;">
                        <div class="custom-apt-row" style="align-items:flex-end;">
                            <div style="flex:0.9;">
                                <label class="custom-apt-label">Currency</label>
                                <select id="customCurrency" class="custom-apt-input" style="padding:10px; border-radius:10px; border:1.5px solid var(--border); background:rgba(0,0,0,0.1); color:var(--text); font-size:0.85rem; font-family:inherit; width:100%;" onchange="onPriceInput()">
                                    <option value="USD">$ USD</option>
                                    <option value="GBP">¬£ GBP</option>
                                    <option value="EUR">‚Ç¨ EUR</option>
                                    <option value="GHS">‚Çµ GHS</option>
                                    <option value="NGN">‚Ç¶ NGN</option>
                                    <option value="KES">KSh KES</option>
                                    <option value="ZAR">R ZAR</option>
                                    <option value="CAD">CA$ CAD</option>
                                    <option value="AUD">A$ AUD</option>
                                    <option value="AED">AED</option>
                                    <option value="QAR">QAR</option>
                                    <option value="INR">‚Çπ INR</option>
                                </select>
                            </div>
                            <div style="flex:2;">
                                <label class="custom-apt-label">Amount <span style="font-weight:400;">(leave blank to skip)</span></label>
                                <input type="number" id="customPriceAmount" class="custom-apt-input" placeholder="e.g. 850" min="0" oninput="onPriceInput()" style="width:100%;">
                            </div>
                        </div>
                    </div>
                    <div id="showPriceToggleWrap" class="hidden" style="margin-top:10px; display:flex; align-items:center; gap:10px; padding:10px 14px; background:rgba(34,197,94,0.07); border:1px dashed #22c55e; border-radius:12px;">
                        <input type="checkbox" id="showPriceOnTicket" style="width:17px;height:17px;accent-color:#22c55e;cursor:pointer;" checked>
                        <label for="showPriceOnTicket" style="font-size:0.8rem; font-weight:600; color:var(--text); cursor:pointer;">Show price on generated ticket</label>
                    </div>
                </div>

                <div style="text-align:center; margin-top:18px; margin-bottom:6px;">
                    <span style="display:inline-flex; align-items:center; gap:6px; background:rgba(56,189,248,0.08); border:1px dashed var(--accent); padding:5px 16px; border-radius:50px; font-size:0.78rem; color:var(--text-dim); font-style:italic;">
                        <i class="fas fa-ticket-alt" style="color:var(--accent);"></i>
                        Flight ticket generation ‚Äî <strong style="color:var(--accent);">GHS 50 / ~$4.55</strong> per ticket
                    </span>
                </div>

                <button onclick="payAndGenerate()" class="btn-auth" style="width:100%;">
                    <i class="fas fa-bolt" style="margin-right:6px;"></i> Generate Ticket
                </button>

                <div class="info-notice-box">
                    <i class="fas fa-circle-info"></i>
                    <p>Please review the time intervals between both destinations before entering them for an accurate flight. Also make sure the destination names are correctly spelled to avoid errors. Generating a new ticket creates a fresh tracking session starting from 0% progress.</p>
                </div>
            </div>

            <div id="successArea" class="hidden ticket-wrapper">
                <div class="ticket-visual" id="ticketImage">
                    <div class="ticket-main">
                        <div class="airline-branding">
                            <img id="logoImg" src="" class="airline-logo">
                            <span id="displayAirline" class="airline-name">AIRLINE</span>
                        </div>
                        
                        <div class="pass-row">
                            <div><span class="pass-label">Passenger Name</span><div id="displayName" class="pass-val">---</div></div>
                            <div style="text-align: right;"><span class="pass-label">Flight Class</span><div class="pass-val" id="displayClass">---</div></div>
                        </div>

                        <div class="pass-row" style="margin: 30px 0;">
                            <div>
                                <span class="pass-label">From</span>
                                <div id="displayFrom" class="pass-val" style="font-size: 1.8rem; line-height:1.1;">---</div>
                                <div id="displayFromCountry" style="font-size:0.7rem; color:#64748b; font-weight:600; margin-top:2px;">---</div>
                                <div id="displayFromAirport" style="font-size:0.65rem; color:#0284c7; font-weight:800; margin-top:3px; letter-spacing:0.5px;"></div>
                            </div>
                            <div style="display:flex; align-items:center; color:var(--accent);"><i class="fas fa-plane fa-2x"></i></div>
                            <div style="text-align: right;">
                                <span class="pass-label">To</span>
                                <div id="displayTo" class="pass-val" style="font-size: 1.8rem; line-height:1.1;">---</div>
                                <div id="displayToCountry" style="font-size:0.7rem; color:#64748b; font-weight:600; margin-top:2px;">---</div>
                                <div id="displayToAirport" style="font-size:0.65rem; color:#0284c7; font-weight:800; margin-top:3px; letter-spacing:0.5px;"></div>
                            </div>
                        </div>

                        <div class="pass-row">
                            <div><span class="pass-label">Departure Date</span><div id="displayDate" class="pass-val">---</div></div>
                            <div><span class="pass-label">Gate / Terminal</span><div class="pass-val" id="displayGate">---</div></div>
                            <div style="text-align: right;"><span class="pass-label">Arrival Time</span><div class="pass-val" id="displayArrival">---</div></div>
                        </div>
                        <div id="transitRow" class="pass-row hidden" style="background:#f8fafc; border-radius:10px; padding:10px; border:1px dashed #cbd5e1;">
                            <div><span class="pass-label" style="color:#f59e0b;">‚úà Via Transit</span><div id="displayTransit" class="pass-val" style="font-size:0.95rem; color:#0f172a;">---</div><div id="displayTransitAirport" style="font-size:0.65rem; color:#0284c7; font-weight:800; margin-top:2px;"></div></div>
                            <div style="text-align:right;"><span class="pass-label">Layover</span><div id="displayLayover" class="pass-val" style="font-size:0.95rem;">---</div></div>
                        </div>
                    </div>

                    <div class="ticket-stub">
                        <div>
                            <span class="pass-label">SkyTrack ID</span>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <div id="displayID" class="ticket-id-val">--</div>
                                <i class="fas fa-copy" onclick="copyOnlyID()" style="cursor: pointer; font-size: 0.8rem; color: var(--accent);"></i>
                            </div>
                        </div>
                        <div>
                            <span class="pass-label">Terminal</span>
                            <div id="stubTerminal" style="font-size: 0.8rem; font-weight: 700;">---</div>
                        </div>
                        <div>
                            <span class="pass-label">Airport Code</span>
                            <div id="stubAirportCode" style="font-size: 0.85rem; font-weight: 800; color:#0284c7; letter-spacing:1px;">---</div>
                        </div>
                        <div id="stubPriceWrap" style="display:none;">
                            <span class="pass-label">Ticket Price</span>
                            <div id="stubPrice" style="font-size: 1rem; font-weight: 800; color:#22c55e;">---</div>
                        </div>
                        <div class="barcode">123456789</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; width: 100%;">
                    <button class="btn-auth" onclick="downloadPDF()"><i class="fas fa-file-pdf"></i> PDF</button>
                    <button class="btn-auth cancel-flight-btn" onclick="cancelFlight()"><i class="fas fa-times-circle"></i> Cancel Flight</button>
                </div>
                <button class="btn-auth" style="width: 100%; margin-top: 15px; background: #6366f1;" onclick="copyTrackingLink()">
                    <i class="fas fa-link"></i> Copy Tracking Link
                </button>
            </div>

            <div class="history-section" id="historyArea">
                <h3 style="margin: 20px 0 10px; color: var(--text-dim);">Flight History</h3>
                <div id="historyList"></div>
            </div>
        </div>
    </section>

    <footer>
        <div class="footer-container">
            <div class="footer-brand">
                <h2>SkyTrack Pro</h2>
                <p>Redefining how travelers share their journey. Secure, real-time, and built for the modern sky-dweller.</p>
            </div>
            <div class="footer-links">
                <h4>Navigation</h4>
                <ul>
                    <li><a href="#" onclick="toggleDashboard(false)">Home</a></li>
                    <li><a href="about.html">About Us</a></li>
                    <li><a href="contact.html">Contact</a></li>
                    <li><a href="track.html">Live Tracker</a></li>
                </ul>
            </div>
            <div class="footer-links">
                <h4>Resources</h4>
                <ul>
                    <li><a href="#">Flight API</a></li>
                    <li><a href="#">Travel Insights</a></li>
                    <li><a href="#">AeroData Logs</a></li>
                    <li><a href="#">Privacy Policy</a></li>
                </ul>
            </div>
            <div class="footer-links">
                <h4>Support</h4>
                <ul>
                    <li><a href="contact.html">Help Center</a></li>
                    <li><a href="safety.html">Safety Guidelines</a></li>
                    <li><a href="contact.html">Technical Support</a></li>
                    <li><a href="safety.html">Terms of Service</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            &copy; 2026 SkyTrack Pro. Powered by Team OG. Built for global connectivity.
        </div>
    </footer>

    <!-- Firebase Auth + Firestore -->
    <script type="module">
        import { initializeApp }    from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, where, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

        const app = initializeApp({
            apiKey:            "AIzaSyAcnU7sDm8pWkWssgxMPA4q2rdpS8a6qDw",
            authDomain:        "skytrack-28c83.firebaseapp.com",
            projectId:         "skytrack-28c83",
            storageBucket:     "skytrack-28c83.firebasestorage.app",
            messagingSenderId: "876231264024",
            appId:             "1:876231264024:web:eb42a685ee2bad2020c06d",
            measurementId:     "G-FE2WV6KZ20"
        });
        const auth = getAuth(app);
        const db   = getFirestore(app);

        // Expose Firestore helpers globally so non-module scripts can call them
        window._db = db;
        window._fsSetFlight = async (id, data) => {
            await setDoc(doc(db, 'flights', id), data);
        };
        window._fsGetFlight = async (id) => {
            const snap = await getDoc(doc(db, 'flights', id));
            return snap.exists() ? snap.data() : null;
        };
        window._fsUpdateFlight = async (id, fields) => {
            await updateDoc(doc(db, 'flights', id), fields);
        };
        window._fsGetUserFlights = async (uid) => {
            const q = query(
                collection(db, 'flights'),
                where('uid', '==', uid),
                orderBy('createdAt', 'desc'),
                limit(5)
            );
            const snap = await getDocs(q);
            return snap.docs.map(d => d.data());
        };

        onAuthStateChanged(auth, user => {
            if(user){
                localStorage.setItem('isLoggedIn','true');
                localStorage.setItem('userEmail', user.email||'');
                localStorage.setItem('userName',  user.displayName||'');
                localStorage.setItem('uid', user.uid);
            } else {
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('userName');
                localStorage.removeItem('uid');
            }
            window._fbAuth    = auth;
            window._fbSignOut = signOut;
            window._fbReady   = true;
            updateNavUI(!!user);
        });
    </script>

    <script>
        function updateNavUI(loggedIn){
            const navBtn  = document.getElementById('navActionBtn');
            const nameTag = document.getElementById('navUserName');
            const histLink = document.getElementById('historyNavLink');
            const userName= localStorage.getItem('userName') || localStorage.getItem('userEmail') || '';
            if(loggedIn){
                navBtn.innerHTML  = '<i class="fas fa-sign-out-alt"></i> Log Out';
                navBtn.style.background = '#ef4444';
                if(nameTag && userName){ nameTag.textContent = 'Hi, ' + userName.split(' ')[0]; nameTag.style.display='inline'; }
                if(histLink) histLink.style.display = 'block';
                loadHistory();
            } else {
                navBtn.innerHTML  = 'Get Started';
                navBtn.style.background = 'var(--accent)';
                if(nameTag) nameTag.style.display='none';
                if(histLink) histLink.style.display = 'none';
            }
        }

        function checkAuth(){
            return localStorage.getItem('isLoggedIn') === 'true';
        }

        function handleAuthClick(){
            if(checkAuth()){
                const doLogout = ()=>{
                    localStorage.removeItem('isLoggedIn');
                    localStorage.removeItem('userEmail');
                    localStorage.removeItem('userName');
                    window.location.reload();
                };
                if(window._fbAuth && window._fbSignOut){
                    window._fbSignOut(window._fbAuth).then(doLogout).catch(doLogout);
                } else { doLogout(); }
            } else {
                window.location.href = 'login.html';
            }
        }

        function toggleDashboard(show){
            if(show && !checkAuth()){
                window.location.href = 'login.html';
                return;
            }
            const hero = document.getElementById('heroSection');
            const dash = document.getElementById('dashboardSection');
            const track = document.getElementById('trackSection');
            const hist = document.getElementById('historySection');
            if(show){
                hero.classList.add('hidden');
                dash.classList.remove('hidden');
                track.classList.add('hidden');
                hist.classList.add('hidden');
                window.scrollTo(0,0);
                loadHistory();
            } else {
                showHeroSection();
            }
        }

        function showHeroSection() {
            document.getElementById('heroSection').classList.remove('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('trackSection').classList.add('hidden');
            document.getElementById('historySection').classList.add('hidden');
            window.scrollTo(0,0);
        }

        function showTrackSection() {
            document.getElementById('heroSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('trackSection').classList.remove('hidden');
            document.getElementById('historySection').classList.add('hidden');
            window.scrollTo(0,0);
            // Load history in track section for logged-in users
            loadHeroTrackHistory();
        }

        function showHistorySection() {
            if(!checkAuth()){
                window.location.href = 'login.html';
                return;
            }
            document.getElementById('heroSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('trackSection').classList.add('hidden');
            document.getElementById('historySection').classList.remove('hidden');
            window.scrollTo(0,0);
            refreshHistorySection();
        }

        async function refreshHistorySection() {
            const list = document.getElementById('fullHistoryList');
            if(!list) return;
            list.innerHTML = '<p style="color:var(--text-dim); font-size:0.85rem; text-align:center; padding:20px 0;"><span class="dot-spin" style="display:inline-block;"></span> Loading your flights‚Ä¶</p>';

            let flights = [];
            const uid = localStorage.getItem('uid');
            if(uid && window._fsGetUserFlights) {
                try { flights = await window._fsGetUserFlights(uid); } catch(e) {}
            }
            if(!flights.length) {
                flights = JSON.parse(localStorage.getItem('ticketHistory') || '[]');
            }

            if(!flights.length) {
                list.innerHTML = '<div style="text-align:center; padding:40px 0;"><div style="font-size:3rem; margin-bottom:12px;">üé´</div><p style="color:var(--text-dim);">No flights found. Generate a ticket to get started!</p></div>';
                return;
            }

            list.innerHTML = '';
            flights.forEach(f => {
                const isCancelled = f.cancelled || false;
                const id = f.id || f;
                const from = f.fromCity || f.from || '?';
                const to   = f.toCity   || f.to   || '?';
                const date    = f.date    || '';
                const airline = f.airline || '';

                const card = document.createElement('div');
                card.className = 'hist-card';
                card.style.cssText = `background:var(--card); border:1px solid var(--border); border-radius:18px; margin-bottom:14px; overflow:hidden; box-shadow:0 2px 12px rgba(0,0,0,0.06); ${isCancelled ? 'opacity:0.65;' : ''}`;

                card.innerHTML = `
                    <!-- status stripe -->
                    <div style="height:4px; background:${isCancelled ? '#ef4444' : 'linear-gradient(90deg,#0284c7,#38bdf8)'};"></div>

                    <div style="padding:16px;">
                        <!-- row 1: ID + status badge -->
                        <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:6px; margin-bottom:10px;">
                            <span style="color:var(--accent); font-weight:900; font-size:1rem; letter-spacing:1.5px;">${id}</span>
                            ${isCancelled
                                ? '<span style="background:#fef2f2; color:#ef4444; font-size:0.62rem; font-weight:800; padding:3px 10px; border-radius:20px; border:1px solid #fca5a5; white-space:nowrap;">‚úó CANCELLED</span>'
                                : '<span style="background:#f0fdf4; color:#16a34a; font-size:0.62rem; font-weight:800; padding:3px 10px; border-radius:20px; border:1px solid #86efac; white-space:nowrap;">‚úà ACTIVE</span>'}
                        </div>

                        <!-- row 2: route -->
                        <div style="font-weight:800; font-size:1.05rem; margin-bottom:5px; display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                            <span>${from}</span>
                            <i class="fas fa-long-arrow-alt-right" style="color:var(--accent); font-size:0.85rem;"></i>
                            <span>${to}</span>
                        </div>

                        <!-- row 3: meta info -->
                        <div style="font-size:0.75rem; color:var(--text-dim); margin-bottom:14px;">${airline ? airline + ' &nbsp;¬∑&nbsp; ' : ''}${date}</div>

                        <!-- row 4: action buttons ‚Äî stacked on mobile, inline on larger -->
                        <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:center;">
                            ${!isCancelled
                                ? `<button onclick="window.location.href='track.html?id=${id}'" class="btn-auth" style="flex:1; min-width:100px; padding:0.55rem 0.8rem; font-size:0.78rem; border-radius:12px; white-space:nowrap; justify-content:center;">
                                       <i class="fas fa-satellite-dish" style="margin-right:5px;"></i> Track Live
                                   </button>`
                                : `<span style="flex:1; min-width:100px; text-align:center; font-size:0.75rem; font-weight:800; color:#ef4444; padding:0.55rem 0;">Flight Cancelled</span>`}

                            <!-- Copy ID button -->
                            <button
                                onclick="copyHistId('${id}', this)"
                                title="Copy Booking ID"
                                style="display:flex; align-items:center; gap:5px; background:transparent; border:1.5px solid var(--border); color:var(--text-dim); padding:0.5rem 0.9rem; border-radius:12px; font-size:0.75rem; cursor:pointer; font-weight:700; white-space:nowrap; transition:all 0.2s;">
                                <i class="fas fa-hashtag"></i> Copy ID
                            </button>

                            <!-- Copy Link button -->
                            <button
                                onclick="copyHistLink('${id}', this)"
                                title="Copy Shareable Link"
                                style="display:flex; align-items:center; gap:5px; background:transparent; border:1.5px solid var(--border); color:var(--text-dim); padding:0.5rem 0.9rem; border-radius:12px; font-size:0.75rem; cursor:pointer; font-weight:700; white-space:nowrap; transition:all 0.2s;">
                                <i class="fas fa-link"></i> Copy Link
                            </button>
                        </div>
                    </div>`;

                list.appendChild(card);
            });
        }

        function copyIdToClipboard(id) {
            navigator.clipboard.writeText(id).then(() => showToast('‚úÖ ID Copied: ' + id, '#22c55e'));
        }

        function copyHistId(id, btn) {
            navigator.clipboard.writeText(id).then(() => {
                const orig = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                btn.style.borderColor = '#22c55e';
                btn.style.color = '#22c55e';
                setTimeout(() => { btn.innerHTML = orig; btn.style.borderColor = ''; btn.style.color = ''; }, 2000);
            }).catch(() => showToast('ID: ' + id, '#64748b'));
        }

        function copyHistLink(id, btn) {
            const base = window.location.href.replace(/\/[^/]*$/, '/');
            const link = base + 'track.html?id=' + id + '&share=1';
            navigator.clipboard.writeText(link).then(() => {
                const orig = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                btn.style.borderColor = '#22c55e';
                btn.style.color = '#22c55e';
                setTimeout(() => { btn.innerHTML = orig; btn.style.borderColor = ''; btn.style.color = ''; }, 2000);
            }).catch(() => showToast('Link copy failed', '#ef4444'));
        }

        async function loadHeroTrackHistory() {
            const wrap = document.getElementById('heroTrackHistory');
            if(!wrap) return;
            if(!checkAuth()) { wrap.innerHTML = ''; return; }
            
            let flights = [];
            const uid = localStorage.getItem('uid');
            if(uid && window._fsGetUserFlights) {
                try { flights = await window._fsGetUserFlights(uid); } catch(e) {}
            }
            if(!flights.length) {
                flights = JSON.parse(localStorage.getItem('ticketHistory') || '[]');
            }
            if(!flights.length) { wrap.innerHTML = ''; return; }

            wrap.innerHTML = `<h4 style="font-weight:800; color:var(--text-dim); font-size:0.8rem; text-transform:uppercase; letter-spacing:1px; margin-bottom:12px;"><i class="fas fa-history" style="margin-right:6px;"></i>Your Recent Flights</h4>`;
            flights.slice(0,5).forEach(f => {
                const isCancelled = f.cancelled || false;
                const id = f.id || f;
                const from = f.fromCity || f.from || '?';
                const to = f.toCity || f.to || '?';
                const div = document.createElement('div');
                div.style.cssText = `background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px 16px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; ${isCancelled ? 'opacity:0.6;' : ''}`;
                div.innerHTML = `
                    <div>
                        <div style="color:var(--accent); font-weight:800; font-size:0.85rem;">${id}${isCancelled ? ' <span style="color:#ef4444; font-size:0.65rem;">‚úó CANCELLED</span>' : ''}</div>
                        <div style="font-weight:600; font-size:0.82rem;">${from} ‚Üí ${to}</div>
                    </div>
                    ${!isCancelled ? `<button onclick="quickTrackLookup('${id}')" class="btn-auth" style="padding:0.4rem 0.9rem; font-size:0.72rem;">View</button>` : '<span style="color:#ef4444; font-size:0.7rem; font-weight:800;">CANCELLED</span>'}`;
                wrap.appendChild(div);
            });
        }

        async function heroTrackSearch() {
            const input = document.getElementById('heroTrackInput').value.trim().toUpperCase();
            if(!input) return;
            const result = document.getElementById('heroTrackResult');
            result.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-dim);"><div class="dot-spin" style="display:inline-block; margin-right:8px;"></div> Looking up flight‚Ä¶</div>';

            let data = null;
            const local = localStorage.getItem('flight_' + input);
            if(local) { try { data = JSON.parse(local); } catch(e){} }
            if(!data && window._fsGetFlight) {
                try { data = await window._fsGetFlight(input); } catch(e){}
            }

            if(!data) {
                result.innerHTML = `<div style="background:#fef2f2; border:1px solid #fca5a5; border-radius:16px; padding:24px; text-align:center;">
                    <div style="font-size:2rem; margin-bottom:8px;">üîç</div>
                    <div style="font-weight:800; color:#b91c1c; margin-bottom:6px;">Flight Not Found</div>
                    <div style="color:#64748b; font-size:0.85rem;">No flight with ID <strong>${input}</strong> found. Double-check the ID and try again.</div>
                </div>`;
                return;
            }

            // Show full ticket preview
            const isCancelled = data.cancelled || false;
            const fromAptLine = data.fromAirportCode ? `<div style="font-size:0.72rem;color:#0284c7;font-weight:800;margin-top:3px;">‚úà ${data.fromAirportCode} ‚Äî ${data.fromAirportName}</div>` : '';
            const toAptLine   = data.toAirportCode   ? `<div style="font-size:0.72rem;color:#0284c7;font-weight:800;margin-top:3px;">‚úà ${data.toAirportCode} ‚Äî ${data.toAirportName}</div>` : '';
            const priceRow    = data.ticketPrice ? `<div><span style="font-size:0.65rem;color:#0284c7;font-weight:800;text-transform:uppercase;display:block;margin-bottom:3px;">Ticket Price</span><div style="font-weight:800;color:#16a34a;">${data.ticketPrice}</div></div>` : '';

            result.innerHTML = `<div style="background:var(--card); border:1px solid var(--border); border-radius:20px; overflow:hidden; box-shadow:0 12px 40px rgba(0,0,0,0.1);">
                ${isCancelled ? '<div style="background:#ef4444; color:#fff; text-align:center; padding:8px; font-weight:900; letter-spacing:3px; font-size:0.85rem;">‚úó FLIGHT CANCELLED</div>' : '<div style="background:linear-gradient(135deg,#0284c7,#38bdf8); color:#fff; text-align:center; padding:8px; font-weight:800; font-size:0.8rem; letter-spacing:2px;">‚úà SKYTRACK ELITE PASS</div>'}
                <div style="padding:24px;">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:20px; padding-bottom:16px; border-bottom:2px dashed var(--border);">
                        <div>
                            <div style="font-size:0.65rem; color:#0284c7; font-weight:800; text-transform:uppercase; letter-spacing:1px; margin-bottom:3px;">Passenger</div>
                            <div style="font-size:1.3rem; font-weight:900;">${data.name}</div>
                            <div style="font-size:0.75rem; color:var(--text-dim); margin-top:2px;">${data.class || ''} ¬∑ ${data.airline || ''}</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:0.65rem; color:#0284c7; font-weight:800; text-transform:uppercase; letter-spacing:1px; margin-bottom:3px;">SkyTrack ID</div>
                            <div style="font-size:1.1rem; font-weight:900; color:#0284c7; letter-spacing:1px;">${input}</div>
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr auto 1fr; gap:8px; align-items:center; margin-bottom:20px;">
                        <div>
                            <div style="font-size:0.65rem; color:#0284c7; font-weight:800; text-transform:uppercase; letter-spacing:1px; margin-bottom:3px;">From</div>
                            <div style="font-size:1.4rem; font-weight:900;">${data.fromCity || data.from}</div>
                            <div style="font-size:0.72rem; color:var(--text-dim);">${data.fromCountry || ''}</div>
                            ${fromAptLine}
                        </div>
                        <div style="text-align:center; font-size:1.5rem; color:#0284c7;">‚úà</div>
                        <div style="text-align:right;">
                            <div style="font-size:0.65rem; color:#0284c7; font-weight:800; text-transform:uppercase; letter-spacing:1px; margin-bottom:3px;">To</div>
                            <div style="font-size:1.4rem; font-weight:900;">${data.toCity || data.to}</div>
                            <div style="font-size:0.72rem; color:var(--text-dim);">${data.toCountry || ''}</div>
                            ${toAptLine}
                        </div>
                    </div>
                    ${data.hasTransit ? `<div style="background:rgba(245,158,11,0.08); border:1px solid #f59e0b; border-radius:12px; padding:10px 14px; margin-bottom:16px; font-size:0.82rem;"><span style="color:#f59e0b; font-weight:800;">‚è± Via ${data.transitCity}${data.transitCountry ? ', '+data.transitCountry : ''}</span>${data.transitAirportCode ? ' ¬∑ ' + data.transitAirportCode : ''} ¬∑ Layover: ${data.transitDuration} min</div>` : ''}
                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; background:rgba(0,0,0,0.04); padding:14px; border-radius:12px; margin-bottom:16px;">
                        <div><div style="font-size:0.62rem; color:#0284c7; font-weight:800; text-transform:uppercase; margin-bottom:2px;">Date</div><div style="font-weight:800; font-size:0.85rem;">${data.date}</div></div>
                        <div><div style="font-size:0.62rem; color:#0284c7; font-weight:800; text-transform:uppercase; margin-bottom:2px;">Departure</div><div style="font-weight:800; font-size:0.85rem;">${data.dep}</div></div>
                        <div><div style="font-size:0.62rem; color:#0284c7; font-weight:800; text-transform:uppercase; margin-bottom:2px;">Arrival</div><div style="font-weight:800; font-size:0.85rem;">${data.arr}</div></div>
                        <div><div style="font-size:0.62rem; color:#0284c7; font-weight:800; text-transform:uppercase; margin-bottom:2px;">Terminal</div><div style="font-weight:800; font-size:0.85rem;">${data.terminal || 'T1'}</div></div>
                        <div><div style="font-size:0.62rem; color:#0284c7; font-weight:800; text-transform:uppercase; margin-bottom:2px;">Gate</div><div style="font-weight:800; font-size:0.85rem;">${data.gate || '‚Äî'}</div></div>
                        ${priceRow}
                    </div>
                    <button onclick="window.location.href='track.html?id=${input}'" class="btn-auth" style="width:100%; padding:0.9rem; font-size:0.95rem;">
                        <i class="fas fa-satellite-dish" style="margin-right:8px;"></i> View Live Flight Progress
                    </button>
                </div>
            </div>`;
        }

        async function quickTrackLookup(id) {
            document.getElementById('heroTrackInput').value = id;
            await heroTrackSearch();
        }

        window.addEventListener('DOMContentLoaded', ()=>{ updateNavUI(checkAuth()); });

        document.querySelectorAll('.time-mask').forEach(input => {
            input.addEventListener('input', (e) => {
                let val = e.target.value.replace(/\D/g, ''); 
                if (val.length > 2) { val = val.slice(0, 2) + ':' + val.slice(2, 4); }
                e.target.value = val;
            });
        });

        function toggleReturnDate(show) {
            document.getElementById('returnGroup').classList.toggle('hidden', !show);
        }

        function toggleTransit(show) {
            document.getElementById('transitFields').classList.toggle('hidden', !show);
        }

        function handleLayoverChange(val) {
            const wrap = document.getElementById('customLayoverWrap');
            wrap.classList.toggle('hidden', val !== 'custom');
            // Make the inner inputs visible in light mode too
            wrap.style.display = val === 'custom' ? 'flex' : 'none';
        }

        function handleAirlineChange(val) {
            const customInput = document.getElementById('customAirline');
            val === 'custom' ? customInput.classList.remove('hidden') : customInput.classList.add('hidden');
            if (val && val !== 'custom') setAirlineLogo(val);
        }

        function trackPrompt() {
            showSkyModal({
                icon: '‚úàÔ∏è',
                title: 'Track Your Flight',
                body: `<p style="color:var(--text-dim);font-size:0.9rem;margin-bottom:16px;">Enter your SkyTrack ID to view live flight progress.</p>
                       <input id="trackPromptInput" type="text" placeholder="e.g. ST-ABC12" style="width:100%; padding:14px; border-radius:12px; border:1.5px solid var(--border); background:rgba(0,0,0,0.05); color:var(--text); font-size:1.1rem; text-align:center; text-transform:uppercase; outline:none; font-family:inherit; margin-bottom:4px;" oninput="this.value=this.value.toUpperCase()">`,
                buttons: [
                    { label: '<i class="fas fa-search"></i> Track Flight', cls: 'modal-btn-primary', action: () => {
                        const id = document.getElementById('trackPromptInput')?.value?.trim()?.toUpperCase();
                        if (!id) { 
                            showSkyModal({ icon: '‚ö†Ô∏è', iconColor:'#f59e0b', title:'No ID Entered', body:'<p>Please type your SkyTrack ID first.</p>', buttons:[{label:'OK', cls:'modal-btn-ghost', action:closeSkyModal}] }); 
                            return; 
                        }
                        closeSkyModal();
                        window.location.href = `track.html?id=${id}`;
                    }},
                    { label: 'Cancel', cls: 'modal-btn-ghost', action: closeSkyModal }
                ]
            });
            setTimeout(()=>{ const inp=document.getElementById('trackPromptInput'); if(inp) inp.focus(); }, 100);
        }

        function generateTicket() {
            const name        = document.getElementById('fullName').value.trim();
            const fromCity    = document.getElementById('fromCity').value.trim();
            const fromCountry = document.getElementById('fromCountry').value.trim();
            const toCity      = document.getElementById('toCity').value.trim();
            const toCountry   = document.getElementById('toCountry').value.trim();

            // Full "City, Country" string ‚Äî passed to map geocoder for accurate pin placement
            const from = fromCity + (fromCountry ? ', ' + fromCountry : '');
            const to   = toCity   + (toCountry   ? ', ' + toCountry   : '');

            const departDate  = document.getElementById('travelDate').value;
            const depTimeRaw  = document.getElementById('depTime').value;
            const depAMPM     = document.getElementById('depAMPM').value;
            const arrTimeRaw  = document.getElementById('arrTime').value;
            const arrAMPM     = document.getElementById('arrAMPM').value;
            const flightClass = document.getElementById('flightClass').value;
            let airline = document.getElementById('airlineSelect').value;
            if (airline === 'custom') airline = document.getElementById('customAirline').value;

            if (!name || !fromCity || !toCity || !departDate || !depTimeRaw || !arrTimeRaw || !airline) {
                showSkyModal({ icon: '‚ö†Ô∏è', iconColor:'#f59e0b', title:'Missing Information', body:'<p>Please fill in all required fields before generating your ticket.</p>', buttons:[{label:'Got it', cls:'modal-btn-primary', action:closeSkyModal}] });
                return;
            }

            // FIX 1 ‚Äî Timezone-safe timestamps
            function getTimestamp(dateStr, timeStr, ampm) {
                let [hours, minutes] = timeStr.split(':').map(Number);
                if (ampm === 'PM' && hours < 12) hours += 12;
                if (ampm === 'AM' && hours === 12) hours = 0;
                const [year, month, day] = dateStr.split('-').map(Number);
                return new Date(year, month - 1, day, hours, minutes, 0, 0).getTime();
            }

            const depTS = getTimestamp(departDate, depTimeRaw, depAMPM);
            let   arrTS = getTimestamp(departDate, arrTimeRaw, arrAMPM);
            if (arrTS <= depTS) arrTS += 24 * 60 * 60 * 1000;

            // Transit validation
            const hasTransit = document.getElementById('hasTransit').checked;
            let transitCity = '', transitCountry = '', transitDurationMins = 0, transitArrTS = 0;
            if (hasTransit) {
                transitCity    = document.getElementById('transitCity').value.trim();
                transitCountry = document.getElementById('transitCountry').value.trim();
                const transitArrRaw  = document.getElementById('transitArrTime').value;
                const transitArrAMPM = document.getElementById('transitArrAMPM').value;
                transitDurationMins  = parseInt(document.getElementById('transitDuration').value);
                if (isNaN(transitDurationMins) || document.getElementById('transitDuration').value === 'custom') {
                    const customVal  = parseFloat(document.getElementById('customLayoverVal').value);
                    const customUnit = document.getElementById('customLayoverUnit').value;
                    if (!customVal || customVal <= 0) {
                        showSkyModal({ icon: '‚ö†Ô∏è', iconColor:'#f59e0b', title:'Invalid Duration', body:'<p>Please enter a valid custom layover duration.</p>', buttons:[{label:'OK', cls:'modal-btn-primary', action:closeSkyModal}] });
                        return;
                    }
                    transitDurationMins = customUnit === 'hours' ? Math.round(customVal * 60) : Math.round(customVal);
                }
                if (!transitCity || !transitCountry) {
                    showSkyModal({ icon: '‚ö†Ô∏è', iconColor:'#f59e0b', title:'Transit Info Missing', body:'<p>Please enter the transit city and country.</p>', buttons:[{label:'OK', cls:'modal-btn-primary', action:closeSkyModal}] });
                    return;
                }
                transitArrTS = getTimestamp(departDate, transitArrRaw || depTimeRaw, transitArrRaw ? transitArrAMPM : depAMPM);
                if (transitArrTS <= depTS) transitArrTS += 24 * 60 * 60 * 1000;
            }

            const id = "ST-" + Math.random().toString(36).substr(2, 5).toUpperCase();

            const flightData = {
                name:        name.toUpperCase(),
                from:        from.toUpperCase(),
                fromCity:    fromCity.toUpperCase(),
                fromCountry: fromCountry.toUpperCase(),
                to:          to.toUpperCase(),
                toCity:      toCity.toUpperCase(),
                toCountry:   toCountry.toUpperCase(),
                date:        departDate,
                dep:         depTimeRaw + " " + depAMPM,
                arr:         arrTimeRaw + " " + arrAMPM,
                departTime:  depTS,
                arrivalTime: arrTS,
                terminal:    ["T1", "T2", "T3"][Math.floor(Math.random() * 3)],
                gate:        String.fromCharCode(65 + Math.floor(Math.random() * 6)) + Math.floor(Math.random() * 30 + 1),
                class:       flightClass,
                airline:     airline.toUpperCase(),
                id:          id,
                hasTransit:       hasTransit,
                transitCity:      hasTransit ? transitCity.toUpperCase() : '',
                transitCountry:   hasTransit ? transitCountry.toUpperCase() : '',
                transit:          hasTransit ? (transitCity + (transitCountry ? ', ' + transitCountry : '')).toUpperCase() : '',
                transitArrTime:   transitArrTS,
                transitDuration:  transitDurationMins,
                cancelled:        false,
                fromAirportCode:  (window._selectedAirports['from']?.iata || ''),
                fromAirportName:  (window._selectedAirports['from']?.name || ''),
                toAirportCode:    (window._selectedAirports['to']?.iata || ''),
                toAirportName:    (window._selectedAirports['to']?.name || ''),
                transitAirportCode: hasTransit ? (window._selectedAirports['transit']?.iata || '') : '',
                transitAirportName: hasTransit ? (window._selectedAirports['transit']?.name || '') : ''
            };

            // Save to Firestore (cloud) so shared links work on any device
            const uid = localStorage.getItem('uid') || 'anonymous';
            const firestoreData = { ...flightData, uid, createdAt: Date.now() };
            if (window._fsSetFlight) {
                window._fsSetFlight(id, firestoreData).catch(err => console.error('Firestore save error:', err));
            }
            // Also keep a local copy for instant access
            localStorage.setItem('flight_' + id, JSON.stringify(flightData));
            updateUserHistory(id, from.toUpperCase(), to.toUpperCase());

            // Store current ticket ID for cancel button
            window._currentTicketId = id;

            document.getElementById('displayName').innerText        = flightData.name;
            document.getElementById('displayFrom').innerText        = flightData.fromCity;
            document.getElementById('displayFromCountry').innerText = flightData.fromCountry;
            document.getElementById('displayTo').innerText          = flightData.toCity;
            document.getElementById('displayToCountry').innerText   = flightData.toCountry;
            document.getElementById('displayAirline').innerText     = flightData.airline;
            document.getElementById('displayID').innerText          = id;
            document.getElementById('displayDate').innerText        = departDate;
            document.getElementById('displayArrival').innerText     = flightData.arr;
            document.getElementById('displayGate').innerText        = flightData.gate + " / " + flightData.terminal;
            document.getElementById('displayClass').innerText       = flightClass;
            document.getElementById('stubTerminal').innerText       = flightData.terminal;

            // Set airline logo
            setAirlineLogo(airline);

            // Airport code display
            const fromApt = flightData.fromAirportCode ? `‚úà ${flightData.fromAirportCode} ‚Äî ${flightData.fromAirportName}` : '';
            const toApt   = flightData.toAirportCode   ? `‚úà ${flightData.toAirportCode} ‚Äî ${flightData.toAirportName}`   : '';
            document.getElementById('displayFromAirport').innerText = fromApt;
            document.getElementById('displayToAirport').innerText   = toApt;
            document.getElementById('stubAirportCode').innerText    = flightData.fromAirportCode || '---';

            // Transit display
            if (hasTransit) {
                document.getElementById('displayTransit').innerText = flightData.transit;
                const dur = flightData.transitDuration;
                document.getElementById('displayLayover').innerText = dur >= 60 ? Math.floor(dur/60) + 'h ' + (dur%60 ? (dur%60)+'m' : '') : dur + 'm';
                document.getElementById('transitRow').classList.remove('hidden');
                const trApt = flightData.transitAirportCode ? `‚úà ${flightData.transitAirportCode} ‚Äî ${flightData.transitAirportName}` : '';
                document.getElementById('displayTransitAirport').innerText = trApt;
            } else {
                document.getElementById('transitRow').classList.add('hidden');
            }
            
            // Show price on ticket if user opted in and price is set
            const priceOnTicket = document.getElementById('showPriceOnTicket')?.checked;
            const stubPriceWrap = document.getElementById('stubPriceWrap');
            const stubPrice = document.getElementById('stubPrice');
            if (priceOnTicket && window._ticketPrice && stubPriceWrap && stubPrice) {
                stubPriceWrap.style.display = 'block';
                stubPrice.innerText = window._ticketPrice;
                // Save price to flightData
                flightData.ticketPrice = window._ticketPrice;
                if (window._fsSetFlight) window._fsSetFlight(id, {...firestoreData, ticketPrice: window._ticketPrice}).catch(()=>{});
            } else if (stubPriceWrap) {
                stubPriceWrap.style.display = 'none';
            }

            document.getElementById('successArea').classList.remove('hidden');
            document.getElementById('successArea').scrollIntoView({ behavior: 'smooth' });

            // ‚îÄ‚îÄ Reset cancel button state for fresh ticket ‚îÄ‚îÄ
            const cancelBtn = document.querySelector('.cancel-flight-btn');
            if (cancelBtn) {
                cancelBtn.innerHTML = '<i class="fas fa-times-circle"></i> Cancel Flight';
                cancelBtn.disabled = false;
                cancelBtn.style.opacity = '';
                cancelBtn.style.cursor = '';
            }
            // Remove any stale CANCELLED overlay from previous ticket
            const ticketImg = document.getElementById('ticketImage');
            ticketImg.querySelectorAll('div[style*="CANCELLED"], div[style*="rgba(239,68,68"]').forEach(el => el.remove());
            
            // Show success modal (auto-dismisses after 3s)
            showSkyModal({
                icon: '‚úÖ', iconColor: '#22c55e',
                title: 'Ticket Generated!',
                body: `<p>Your SkyTrack Elite Pass has been created.<br><strong style="color:var(--accent);">${id}</strong></p>`,
                buttons: [{ label: '<i class="fas fa-scroll"></i> View Ticket', cls: 'modal-btn-primary', action: () => { closeSkyModal(); document.getElementById('successArea').scrollIntoView({behavior:'smooth'}); } }]
            });
            setTimeout(() => { closeSkyModal(); }, 3000);
        } // ‚îÄ‚îÄ end generateTicket ‚îÄ‚îÄ

        function updateUserHistory(id, from, to) {
            let history = JSON.parse(localStorage.getItem('ticketHistory') || '[]');
            history.unshift({id, from, to, date: new Date().toLocaleDateString()});
            localStorage.setItem('ticketHistory', JSON.stringify(history.slice(0, 5)));
            loadHistory();
        }

        function cancelFlight() {
            const id = window._currentTicketId;
            if (!id) return;
            // Read the CURRENT flight data for this specific ID to verify it's not already cancelled
            const raw = localStorage.getItem('flight_' + id);
            const currentData = raw ? JSON.parse(raw) : null;
            if (currentData && currentData.cancelled) {
                showSkyModal({ icon: 'üö´', iconColor:'#ef4444', title:'Already Cancelled', body:'<p>This flight has already been cancelled.</p>', buttons:[{label:'OK', cls:'modal-btn-ghost', action:closeSkyModal}] });
                return;
            }
            showSkyModal({
                icon: '‚ö†Ô∏è', iconColor: '#ef4444',
                title: 'Cancel This Flight?',
                body: `<p>Are you sure you want to cancel flight <strong>${id}</strong>? This action cannot be undone.</p>`,
                buttons: [
                    { label: '<i class="fas fa-times-circle"></i> Yes, Cancel', cls: 'modal-btn-danger', action: () => { closeSkyModal(); executeCancelFlight(id); } },
                    { label: 'Keep Flight', cls: 'modal-btn-ghost', action: closeSkyModal }
                ]
            });
        }

        function executeCancelFlight(id) {
            const key = 'flight_' + id;
            const data = JSON.parse(localStorage.getItem(key));
            if (data) {
                data.cancelled = true;
                localStorage.setItem(key, JSON.stringify(data));
            }
            if (window._fsUpdateFlight) {
                window._fsUpdateFlight(id, { cancelled: true }).catch(err => console.error('Firestore cancel error:', err));
            }
            let history = JSON.parse(localStorage.getItem('ticketHistory') || '[]');
            history = history.map(h => h.id === id ? {...h, cancelled: true} : h);
            localStorage.setItem('ticketHistory', JSON.stringify(history));
            // Only update the cancel button UI if the currently displayed ticket matches this ID
            if (window._currentTicketId === id) {
                const btn = document.querySelector('.cancel-flight-btn');
                if (btn) { btn.innerHTML = '<i class="fas fa-ban"></i> FLIGHT CANCELLED'; btn.disabled = true; btn.style.opacity = '0.6'; btn.style.cursor = 'not-allowed'; }
                const ticketImg = document.getElementById('ticketImage');
                // Remove any existing cancel overlay first
                ticketImg.querySelectorAll('.cancel-overlay').forEach(el => el.remove());
                const overlay = document.createElement('div');
                overlay.className = 'cancel-overlay';
                overlay.style.cssText = 'position:absolute;inset:0;background:rgba(239,68,68,0.15);display:flex;align-items:center;justify-content:center;border-radius:20px;z-index:10;';
                overlay.innerHTML = '<div style="background:#ef4444;color:#fff;font-weight:900;font-size:2rem;padding:12px 32px;border-radius:12px;letter-spacing:4px;transform:rotate(-8deg);box-shadow:0 4px 20px rgba(239,68,68,0.5);">CANCELLED</div>';
                ticketImg.style.position = 'relative';
                ticketImg.appendChild(overlay);
            }
            loadHistory();
            showSkyModal({ icon: 'üö´', iconColor:'#ef4444', title:'Flight Cancelled', body:'<p>Your flight has been cancelled successfully. The status will update for all viewers.</p>', buttons:[{label:'OK', cls:'modal-btn-ghost', action:closeSkyModal}] });
        }

        async function loadHistory() {
            const list = document.getElementById('historyList');
            if (!list) return;

            // Try Firestore first (cloud history, works across devices)
            const uid = localStorage.getItem('uid');
            if (uid && window._fsGetUserFlights) {
                try {
                    const flights = await window._fsGetUserFlights(uid);
                    if (flights.length > 0) {
                        renderHistoryItems(list, flights.map(f => ({
                            id: f.id,
                            from: f.fromCity || f.from,
                            to: f.toCity || f.to,
                            cancelled: f.cancelled || false
                        })));
                        return;
                    }
                } catch(e) { /* fall through to localStorage */ }
            }

            // Fallback: localStorage
            const history = JSON.parse(localStorage.getItem('ticketHistory') || '[]');
            renderHistoryItems(list, history);
        }

        function renderHistoryItems(list, history) {
            list.innerHTML = history.length ? '' : '<p style="font-size:0.8rem; color:var(--text-dim);">No previous tickets found.</p>';
            history.forEach(item => {
                const isCancelled = item.cancelled || false;
                list.innerHTML += `
                    <div class="history-card" style="${isCancelled ? 'opacity:0.6;' : ''}">
                        <div class="history-info">
                            <span class="history-id">${item.id}${isCancelled ? ' <span style="color:#ef4444;font-size:0.7rem;">‚úó CANCELLED</span>' : ''}</span>
                            <span class="history-route">${item.from} <i class="fas fa-arrow-right" style="font-size:0.6rem;"></i> ${item.to}</span>
                        </div>
                        ${isCancelled ? '<span style="color:#ef4444;font-size:0.7rem;font-weight:800;">CANCELLED</span>' : `<button class="btn-auth" style="padding: 0.4rem 0.8rem; font-size: 0.7rem;" onclick="window.location.href='track.html?id=${item.id}'">Track</button>`}
                    </div>`;
            });
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ‚îÄ‚îÄ SOFT MODAL SYSTEM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function showSkyModal({ icon, iconColor, title, body, buttons }) {
            closeSkyModal();
            const overlay = document.createElement('div');
            overlay.className = 'sky-modal-overlay';
            overlay.id = 'skyModalOverlay';
            overlay.innerHTML = `
                <div class="sky-modal">
                    <span class="modal-icon" style="color:${iconColor||'var(--accent)'}">${icon||'‚ÑπÔ∏è'}</span>
                    <h3>${title||''}</h3>
                    <div>${body||''}</div>
                    <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:0.5rem;">
                        ${(buttons||[]).map((b,i)=>`<button class="modal-btn ${b.cls||''}" id="skyModalBtn${i}">${b.label}</button>`).join('')}
                    </div>
                </div>`;
            document.body.appendChild(overlay);
            (buttons||[]).forEach((b,i)=>{
                const el = document.getElementById('skyModalBtn'+i);
                if(el && b.action) el.addEventListener('click', b.action);
            });
            overlay.addEventListener('click', e=>{ if(e.target===overlay) closeSkyModal(); });
        }
        function closeSkyModal() {
            const el = document.getElementById('skyModalOverlay');
            if (el) el.remove();
        }

        // ‚îÄ‚îÄ TOAST NOTIFICATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function showToast(msg, color) {
            const existing = document.getElementById('skyToast');
            if (existing) existing.remove();
            const t = document.createElement('div');
            t.id = 'skyToast';
            t.style.cssText = `position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:${color||'#0284c7'};color:#fff;padding:12px 24px;border-radius:50px;font-weight:700;font-size:0.85rem;z-index:9999;box-shadow:0 8px 25px rgba(0,0,0,0.25);animation:slideUp 0.3s ease;white-space:nowrap;`;
            t.innerHTML = msg;
            document.body.appendChild(t);
            setTimeout(()=>t.remove(), 3000);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ‚îÄ‚îÄ AIRLINE LOGO SYSTEM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Keys are lowercase. setAirlineLogo() lowercases the input so ALL-CAPS
        // names saved in Firestore (e.g. "EMIRATES") still match correctly.
        // URLs use reliable CDN/official sources instead of Wikipedia hotlinks.
        const AIRLINE_LOGO_MAP = {
            'american airlines':  'https://logo.clearbit.com/aa.com',
            'delta air lines':    'https://logo.clearbit.com/delta.com',
            'united airlines':    'https://logo.clearbit.com/united.com',
            'southwest airlines': 'https://logo.clearbit.com/southwest.com',
            'spirit airlines':    'https://logo.clearbit.com/spirit.com',
            'jetblue airways':    'https://logo.clearbit.com/jetblue.com',
            'frontier airlines':  'https://logo.clearbit.com/flyfrontier.com',
            'alaska airlines':    'https://logo.clearbit.com/alaskaair.com',
            'emirates':           'https://logo.clearbit.com/emirates.com',
            'qatar airways':      'https://logo.clearbit.com/qatarairways.com',
            'lufthansa':          'https://logo.clearbit.com/lufthansa.com',
            'british airways':    'https://logo.clearbit.com/britishairways.com',
            'air france':         'https://logo.clearbit.com/airfrance.com',
            'klm':                'https://logo.clearbit.com/klm.com',
            'turkish airlines':   'https://logo.clearbit.com/turkishairlines.com',
            'singapore airlines': 'https://logo.clearbit.com/singaporeair.com',
            'etihad airways':     'https://logo.clearbit.com/etihad.com',
            'air canada':         'https://logo.clearbit.com/aircanada.com',
            'ryanair':            'https://logo.clearbit.com/ryanair.com',
            'easyjet':            'https://logo.clearbit.com/easyjet.com',
            'iberia':             'https://logo.clearbit.com/iberia.com',
            'vueling':            'https://logo.clearbit.com/vueling.com',
            'cathay pacific':     'https://logo.clearbit.com/cathaypacific.com',
            'japan airlines':     'https://logo.clearbit.com/jal.com',
            'ana':                'https://logo.clearbit.com/ana.co.jp',
            'korean air':         'https://logo.clearbit.com/koreanair.com',
            'ethiopian airlines': 'https://logo.clearbit.com/ethiopianairlines.com',
            'kenya airways':      'https://logo.clearbit.com/kenya-airways.com',
            'rwandair':           'https://logo.clearbit.com/rwandair.com',
            'arik air':           'https://logo.clearbit.com/arikair.com',
            'air arabia':         'https://logo.clearbit.com/airarabia.com',
            'flydubai':           'https://logo.clearbit.com/flydubai.com',
            'africa world airlines': 'https://logo.clearbit.com/africaworldairlines.com',
        };

        function setAirlineLogo(airlineName) {
            const logoImg = document.getElementById('logoImg');
            if (!logoImg || !airlineName?.trim()) { if(logoImg) logoImg.style.display='none'; return; }
            // toLowerCase() handles ALL-CAPS names stored in Firestore
            const key = airlineName.trim().toLowerCase();
            const url = AIRLINE_LOGO_MAP[key]
                || `https://logo.clearbit.com/${key.replace(/\s+/g,'').replace(/[^a-z0-9]/g,'')}.com`;
            logoImg.src = url;
            logoImg.style.display = 'block';
            logoImg.onerror = () => { logoImg.style.display = 'none'; };
        }

        function scheduleLogoFetch() {
            clearTimeout(window._logoTimer);
            window._logoTimer = setTimeout(() => {
                const val = document.getElementById('customAirline')?.value?.trim();
                if (val) setAirlineLogo(val);
            }, 800);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ‚îÄ‚îÄ CUSTOM PRICE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        window._ticketPrice = null;

        function onPriceInput() {
            const amount   = parseFloat(document.getElementById('customPriceAmount')?.value);
            const currency = document.getElementById('customCurrency')?.value || 'USD';
            const symbols  = {USD:'$',GBP:'¬£',EUR:'‚Ç¨',GHS:'‚Çµ',NGN:'‚Ç¶',KES:'KSh ',ZAR:'R',CAD:'CA$',AUD:'A$',AED:'AED ',QAR:'QAR ',INR:'‚Çπ'};
            const wrap     = document.getElementById('showPriceToggleWrap');
            if (amount > 0) {
                window._ticketPrice = (symbols[currency] || currency + ' ') + amount.toLocaleString();
                if (wrap) wrap.classList.remove('hidden');
            } else {
                window._ticketPrice = null;
                if (wrap) wrap.classList.add('hidden');
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ‚îÄ‚îÄ IMPROVED PDF DOWNLOAD (Mobile-friendly) ‚îÄ
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const element = document.getElementById('ticketImage');

            // Temporarily make the ticket render at a fixed wide size for PDF quality
            const origStyle = element.style.cssText;
            element.style.cssText += '; min-width:700px; max-width:700px; width:700px; flex-direction:row !important;';

            const canvas = await html2canvas(element, { 
                useCORS: true, scale: 2, 
                width: 700, 
                logging: false,
                imageTimeout: 3000,
            });

            element.style.cssText = origStyle;

            const imgData = canvas.toDataURL('image/jpeg', 0.95);
            // A4 Landscape proportioned to ticket
            const pdfW = 297, pdfH = 130;
            const pdf  = new jsPDF({ orientation: 'landscape', unit: 'mm', format: [pdfW, pdfH] });
            pdf.addImage(imgData, 'JPEG', 5, 5, pdfW - 10, pdfH - 10);
            pdf.save('SkyTrack-Elite-Ticket.pdf');
            showToast('üìÑ Ticket PDF downloaded!', '#0284c7');
        }

        // Trigger airline logo on initial page load from select default
        window.addEventListener('DOMContentLoaded', ()=>{
            const sel = document.getElementById('airlineSelect');
            if (sel && sel.value && sel.value !== 'custom') setAirlineLogo(sel.value);
        });

        function copyOnlyID() {
            const id = document.getElementById('displayID').innerText;
            navigator.clipboard.writeText(id).then(() => {
                showToast('‚úÖ ID Copied: ' + id, '#22c55e');
            }).catch(() => showToast('ID: ' + id, '#64748b'));
        }

        function copyTrackingLink() {
            const id   = document.getElementById('displayID').innerText;
            const base = window.location.href.replace(/\/[^/]*$/, '/');
            const link = base + 'track.html?id=' + id + '&share=1';
            navigator.clipboard.writeText(link).then(() => {
                const btn = document.querySelector('[onclick="copyTrackingLink()"]');
                const orig = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Link Copied!';
                btn.style.background = '#22c55e';
                setTimeout(() => { btn.innerHTML = orig; btn.style.background = '#6366f1'; }, 2500);
            }).catch(() => showToast('Tracking link: ' + link, '#64748b'));
        }        const themeBtn = document.getElementById('theme-toggle');
        const themeIcon = themeBtn.querySelector('i');
        const html = document.documentElement;

        themeBtn.addEventListener('click', () => {
            if (html.getAttribute('data-theme') === 'dark') {
                html.setAttribute('data-theme', 'light');
                themeIcon.className = 'fas fa-sun';
            } else {
                html.setAttribute('data-theme', 'dark');
                themeIcon.className = 'fas fa-moon';
            }
        });

        const menuBtn = document.getElementById('menuBtn');
        const navContent = document.getElementById('navContent');
        menuBtn.addEventListener('click', () => {
            navContent.classList.toggle('active');
            menuBtn.classList.toggle('fa-times');
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ‚îÄ‚îÄ‚îÄ AI-POWERED AIRPORT LOOKUP SYSTEM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Uses Claude AI to intelligently find airports for any city
        // worldwide with accurate IATA codes and airport names.
        // If AI is unavailable, user enters airport manually via
        // the custom entry fields (city name pre-filled as hint).
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        window._selectedAirports = { from: null, to: null, transit: null };
        const _airportTimers = {};
        const _airportCache = {}; // cache city ‚Üí airports to avoid repeat API calls

        function renderAirportOptions(slot, airports, label) {
            const sel  = document.getElementById(slot+'AirportSelect');
            const chip = document.getElementById(slot+'AirportChip');
            if (!sel) return;
            sel.innerHTML = '<option value="">‚Äî select airport ‚Äî</option>';
            airports.forEach((ap, i) => {
                const opt = document.createElement('option');
                opt.value = ap.iata;
                opt.dataset.name = ap.name;
                opt.textContent = ap.dist > 0
                    ? `${ap.iata}  ‚Äî  ${ap.name}  (${ap.dist} km away)`
                    : `${ap.iata}  ‚Äî  ${ap.name}`;
                if (i===0) opt.selected = true;
                sel.appendChild(opt);
            });
            sel.style.display = 'block';
            window._selectedAirports[slot] = { iata: airports[0].iata, name: airports[0].name };
            chip.innerHTML = `<span class="airport-chip">‚úà ${airports[0].iata} ‚Äî ${airports[0].name}</span>`;
            setAirportStatus(slot, `<i class="fas fa-check-circle" style="color:#22c55e;"></i> ${airports.length} airport${airports.length>1?'s':''} found ${label}`);
        }

        function scheduleAirportFetch(slot) {
            clearTimeout(_airportTimers[slot]);
            _airportTimers[slot] = setTimeout(() => fetchAirportsForSlot(slot), 700);
        }

        function getSlotCityCountry(slot) {
            if (slot==='from')    return { city:document.getElementById('fromCity').value.trim(),    country:document.getElementById('fromCountry').value.trim() };
            if (slot==='to')      return { city:document.getElementById('toCity').value.trim(),      country:document.getElementById('toCountry').value.trim() };
            if (slot==='transit') return { city:document.getElementById('transitCity').value.trim(), country:document.getElementById('transitCountry').value.trim() };
        }

        function setAirportStatus(slot, html) {
            const el = document.getElementById(slot+'AirportStatus');
            if (el) el.innerHTML = html;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // FREE MULTI-SOURCE AIRPORT LOOKUP
        // Sources (tried in order):
        //  1. Built-in curated IATA database (instant, 1000+ airports)
        //  2. Overpass API (OpenStreetMap) ‚Äî finds aerodrome nodes by city
        //  3. Nominatim reverse geocode of airport name search
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // Curated IATA database ‚Äî major airports worldwide
        const IATA_DB = {
            // Africa
            'accra':{'acc':{iata:'ACC',name:"Kotoka Int'l Airport",dist:9}},
            'kumasi':{'kms':{iata:'KMS',name:"Kumasi Airport",dist:8}},
            'tamale':{'nyi':{iata:'NYI',name:"Tamale Airport",dist:5}},
            'nairobi':{'nbo':{iata:'NBO',name:"Jomo Kenyatta Int'l Airport",dist:15},'wil':{iata:'WIL',name:"Wilson Airport",dist:7}},
            'mombasa':{'mba':{iata:'MBA',name:"Moi Int'l Airport",dist:10}},
            'lagos':{'los':{iata:'LOS',name:"Murtala Muhammed Int'l Airport",dist:22},'lkr':{iata:'LKR',name:"Lagos Heliport",dist:5}},
            'abuja':{'abv':{iata:'ABV',name:"Nnamdi Azikiwe Int'l Airport",dist:35}},
            'cairo':{'cai':{iata:'CAI',name:"Cairo Int'l Airport",dist:22}},
            'addis ababa':{'add':{iata:'ADD',name:"Bole Int'l Airport",dist:10}},
            'johannesburg':{'jnb':{iata:'JNB',name:"O. R. Tambo Int'l Airport",dist:26},'hla':{iata:'HLA',name:"Lanseria Int'l Airport",dist:42}},
            'cape town':{'cpt':{iata:'CPT',name:"Cape Town Int'l Airport",dist:20}},
            'durban':{'dur':{iata:'DUR',name:"King Shaka Int'l Airport",dist:35}},
            'dakar':{'dkr':{iata:'DKR',name:"Blaise Diagne Int'l Airport",dist:45}},
            'abidjan':{'abj':{iata:'ABJ',name:"F√©lix-Houphou√´t-Boigny Int'l Airport",dist:16}},
            'casablanca':{'cmn':{iata:'CMN',name:"Mohammed V Int'l Airport",dist:30}},
            'tunis':{'tun':{iata:'TUN',name:"Tunis-Carthage Int'l Airport",dist:8}},
            'algiers':{'alg':{iata:'ALG',name:"Houari Boumediene Airport",dist:20}},
            'lome':{'lfw':{iata:'LFW',name:"Lom√©-Tokoin Int'l Airport",dist:6}},
            'cotonou':{'coo':{iata:'COO',name:"Cadjehoun Airport",dist:5}},
            'ouagadougou':{'oua':{iata:'OUA',name:"Ouagadougou Airport",dist:3}},
            'bamako':{'bko':{iata:'BKO',name:"Modibo Keita Int'l Airport",dist:15}},
            'conakry':{'cky':{iata:'CKY',name:"Conakry Int'l Airport",dist:16}},
            'freetown':{'fna':{iata:'FNA',name:"Lungi Int'l Airport",dist:30}},
            'monrovia':{'mlw':{iata:'MLW',name:"Spriggs Payne Airport",dist:5},'rob':{iata:'ROB',name:"Roberts Int'l Airport",dist:56}},
            'libreville':{'lbv':{iata:'LBV',name:"Libreville Int'l Airport",dist:11}},
            'yaounde':{'yao':{iata:'YAO',name:"Yaound√© Nsimalen Int'l Airport",dist:25}},
            'douala':{'dla':{iata:'DLA',name:"Douala Int'l Airport",dist:5}},
            'kigali':{'kgl':{iata:'KGL',name:"Kigali Int'l Airport",dist:12}},
            'kampala':{'enb':{iata:'ENB',name:"Entebbe Int'l Airport",dist:40}},
            'dar es salaam':{'dar':{iata:'DAR',name:"Julius Nyerere Int'l Airport",dist:13}},
            'lusaka':{'lun':{iata:'LUN',name:"Kenneth Kaunda Int'l Airport",dist:25}},
            'harare':{'hre':{iata:'HRE',name:"Robert Gabriel Mugabe Int'l Airport",dist:12}},
            'maputo':{'mpq':{iata:'MPQ',name:"Maputo Int'l Airport",dist:8}},
            'lilongwe':{'llw':{iata:'LLW',name:"Kamuzu Int'l Airport",dist:26}},
            'gaborone':{'gbe':{iata:'GBE',name:"Sir Seretse Khama Int'l Airport",dist:14}},
            'windhoek':{'wdh':{iata:'WDH',name:"Hosea Kutako Int'l Airport",dist:42}},
            'luanda':{'lad':{iata:'LAD',name:"Quatro de Fevereiro Airport",dist:4}},
            'kinshasa':{'fih':{iata:'FIH',name:"Ndjili Int'l Airport",dist:27}},
            'khartoum':{'krt':{iata:'KRT',name:"Khartoum Int'l Airport",dist:5}},
            // Europe
            'london':{'lhr':{iata:'LHR',name:"London Heathrow Airport",dist:24},'lgw':{iata:'LGW',name:"London Gatwick Airport",dist:44},'stn':{iata:'STN',name:"London Stansted Airport",dist:56},'lcy':{iata:'LCY',name:"London City Airport",dist:11}},
            'paris':{'cdg':{iata:'CDG',name:"Charles de Gaulle Airport",dist:30},'ory':{iata:'ORY',name:"Orly Airport",dist:14}},
            'amsterdam':{'ams':{iata:'AMS',name:"Amsterdam Schiphol Airport",dist:17}},
            'frankfurt':{'fra':{iata:'FRA',name:"Frankfurt Airport",dist:12}},
            'madrid':{'mad':{iata:'MAD',name:"Adolfo Su√°rez Madrid-Barajas Airport",dist:13}},
            'barcelona':{'bcn':{iata:'BCN',name:"Barcelona El Prat Airport",dist:14}},
            'rome':{'fco':{iata:'FCO',name:"Leonardo da Vinci Int'l Airport",dist:26},'cia':{iata:'CIA',name:"Rome Ciampino Airport",dist:12}},
            'milan':{'mxp':{iata:'MXP',name:"Milan Malpensa Airport",dist:48},'lin':{iata:'LIN',name:"Milan Linate Airport",dist:7}},
            'berlin':{'ber':{iata:'BER',name:"Berlin Brandenburg Airport",dist:19}},
            'munich':{'muc':{iata:'MUC',name:"Munich Airport",dist:28}},
            'zurich':{'zrh':{iata:'ZRH',name:"Zurich Airport",dist:13}},
            'vienna':{'vie':{iata:'VIE',name:"Vienna Int'l Airport",dist:18}},
            'brussels':{'bru':{iata:'BRU',name:"Brussels Airport",dist:12}},
            'stockholm':{'arn':{iata:'ARN',name:"Stockholm Arlanda Airport",dist:40}},
            'oslo':{'osl':{iata:'OSL',name:"Oslo Gardermoen Airport",dist:47}},
            'copenhagen':{'cph':{iata:'CPH',name:"Copenhagen Airport",dist:8}},
            'helsinki':{'hel':{iata:'HEL',name:"Helsinki-Vantaa Airport",dist:19}},
            'lisbon':{'lis':{iata:'LIS',name:"Humberto Delgado Airport",dist:7}},
            'athens':{'ath':{iata:'ATH',name:"Athens Int'l Airport",dist:33}},
            'istanbul':{'ist':{iata:'IST',name:"Istanbul Airport",dist:43},'saw':{iata:'SAW',name:"Sabiha G√∂k√ßen Int'l Airport",dist:45}},
            'moscow':{'svo':{iata:'SVO',name:"Sheremetyevo Int'l Airport",dist:29},'dme':{iata:'DME',name:"Domodedovo Airport",dist:42}},
            'warsaw':{'waw':{iata:'WAW',name:"Warsaw Chopin Airport",dist:10}},
            'prague':{'prg':{iata:'PRG',name:"V√°clav Havel Airport Prague",dist:17}},
            'budapest':{'bud':{iata:'BUD',name:"Budapest Ferenc Liszt Int'l Airport",dist:16}},
            'bucharest':{'otp':{iata:'OTP',name:"Henri CoandƒÉ Int'l Airport",dist:17}},
            'geneva':{'gva':{iata:'GVA',name:"Geneva Airport",dist:5}},
            'dublin':{'dub':{iata:'DUB',name:"Dublin Airport",dist:10}},
            // Middle East
            'dubai':{'dxb':{iata:'DXB',name:"Dubai Int'l Airport",dist:11},'dwc':{iata:'DWC',name:"Al Maktoum Int'l Airport",dist:65}},
            'abu dhabi':{'auh':{iata:'AUH',name:"Abu Dhabi Int'l Airport",dist:32}},
            'doha':{'doh':{iata:'DOH',name:"Hamad Int'l Airport",dist:15}},
            'riyadh':{'ruh':{iata:'RUH',name:"King Khalid Int'l Airport",dist:35}},
            'jeddah':{'jed':{iata:'JED',name:"King Abdulaziz Int'l Airport",dist:19}},
            'kuwait city':{'kwi':{iata:'KWI',name:"Kuwait Int'l Airport",dist:15}},
            'amman':{'amm':{iata:'AMM',name:"Queen Alia Int'l Airport",dist:30}},
            'beirut':{'bey':{iata:'BEY',name:"Rafic Hariri Int'l Airport",dist:9}},
            'tel aviv':{'tlv':{iata:'TLV',name:"Ben Gurion Int'l Airport",dist:15}},
            'tehran':{'ika':{iata:'IKA',name:"Imam Khomeini Int'l Airport",dist:40}},
            // Asia-Pacific
            'tokyo':{'nrt':{iata:'NRT',name:"Narita Int'l Airport",dist:66},'hnd':{iata:'HND',name:"Haneda Airport",dist:14}},
            'osaka':{'kix':{iata:'KIX',name:"Kansai Int'l Airport",dist:40},'itm':{iata:'ITM',name:"Itami Airport",dist:12}},
            'beijing':{'pek':{iata:'PEK',name:"Beijing Capital Int'l Airport",dist:27},'pkx':{iata:'PKX',name:"Beijing Daxing Int'l Airport",dist:46}},
            'shanghai':{'pvg':{iata:'PVG',name:"Shanghai Pudong Int'l Airport",dist:30},'sha':{iata:'SHA',name:"Shanghai Hongqiao Int'l Airport",dist:13}},
            'hong kong':{'hkg':{iata:'HKG',name:"Hong Kong Int'l Airport",dist:35}},
            'singapore':{'sin':{iata:'SIN',name:"Singapore Changi Airport",dist:18}},
            'bangkok':{'bkk':{iata:'BKK',name:"Suvarnabhumi Airport",dist:28},'dmk':{iata:'DMK',name:"Don Mueang Int'l Airport",dist:25}},
            'kuala lumpur':{'kul':{iata:'KUL',name:"Kuala Lumpur Int'l Airport",dist:50}},
            'jakarta':{'cgk':{iata:'CGK',name:"Soekarno-Hatta Int'l Airport",dist:20}},
            'manila':{'mnl':{iata:'MNL',name:"Ninoy Aquino Int'l Airport",dist:7}},
            'seoul':{'icn':{iata:'ICN',name:"Incheon Int'l Airport",dist:52},'gmp':{iata:'GMP',name:"Gimpo Int'l Airport",dist:14}},
            'taipei':{'tpe':{iata:'TPE',name:"Taiwan Taoyuan Int'l Airport",dist:33}},
            'sydney':{'syd':{iata:'SYD',name:"Sydney Kingsford Smith Airport",dist:10}},
            'melbourne':{'mel':{iata:'MEL',name:"Melbourne Airport",dist:22}},
            'brisbane':{'bne':{iata:'BNE',name:"Brisbane Airport",dist:14}},
            'auckland':{'akl':{iata:'AKL',name:"Auckland Airport",dist:21}},
            'delhi':{'del':{iata:'DEL',name:"Indira Gandhi Int'l Airport",dist:20}},
            'mumbai':{'bom':{iata:'BOM',name:"Chhatrapati Shivaji Maharaj Int'l Airport",dist:28}},
            'bangalore':{'blr':{iata:'BLR',name:"Kempegowda Int'l Airport",dist:35}},
            'chennai':{'maa':{iata:'MAA',name:"Chennai Int'l Airport",dist:16}},
            'kolkata':{'ccu':{iata:'CCU',name:"Netaji Subhas Chandra Bose Int'l Airport",dist:20}},
            'dhaka':{'dac':{iata:'DAC',name:"Hazrat Shahjalal Int'l Airport",dist:22}},
            'colombo':{'cmb':{iata:'CMB',name:"Bandaranaike Int'l Airport",dist:35}},
            'karachi':{'khi':{iata:'KHI',name:"Jinnah Int'l Airport",dist:14}},
            'lahore':{'lhe':{iata:'LHE',name:"Allama Iqbal Int'l Airport",dist:15}},
            'islamabad':{'isb':{iata:'ISB',name:"Islamabad Int'l Airport",dist:28}},
            'kathmandu':{'ktm':{iata:'KTM',name:"Tribhuvan Int'l Airport",dist:6}},
            'yangon':{'rgn':{iata:'RGN',name:"Yangon Int'l Airport",dist:17}},
            'phnom penh':{'pnh':{iata:'PNH',name:"Phnom Penh Int'l Airport",dist:12}},
            'ho chi minh city':{'sgn':{iata:'SGN',name:"Tan Son Nhat Int'l Airport",dist:7}},
            'hanoi':{'han':{iata:'HAN',name:"Noi Bai Int'l Airport",dist:35}},
            // Americas
            'new york':{'jfk':{iata:'JFK',name:"John F. Kennedy Int'l Airport",dist:19},'lga':{iata:'LGA',name:"LaGuardia Airport",dist:13},'ewr':{iata:'EWR',name:"Newark Liberty Int'l Airport",dist:24}},
            'los angeles':{'lax':{iata:'LAX',name:"Los Angeles Int'l Airport",dist:27},'burbank':{iata:'BUR',name:"Hollywood Burbank Airport",dist:19}},
            'chicago':{'ord':{iata:'ORD',name:"O'Hare Int'l Airport",dist:27},'mdw':{iata:'MDW',name:"Midway Int'l Airport",dist:13}},
            'miami':{'mia':{iata:'MIA',name:"Miami Int'l Airport",dist:11},'fll':{iata:'FLL',name:"Fort Lauderdale-Hollywood Int'l Airport",dist:48}},
            'atlanta':{'atl':{iata:'ATL',name:"Hartsfield-Jackson Atlanta Int'l Airport",dist:16}},
            'dallas':{'dfw':{iata:'DFW',name:"Dallas/Fort Worth Int'l Airport",dist:30},'dal':{iata:'DAL',name:"Dallas Love Field",dist:10}},
            'houston':{'iah':{iata:'IAH',name:"George Bush Intercontinental Airport",dist:37},'hou':{iata:'HOU',name:"William P. Hobby Airport",dist:12}},
            'washington':{'iad':{iata:'IAD',name:"Washington Dulles Int'l Airport",dist:45},'dca':{iata:'DCA',name:"Ronald Reagan Washington National Airport",dist:6}},
            'boston':{'bos':{iata:'BOS',name:"Logan Int'l Airport",dist:5}},
            'san francisco':{'sfo':{iata:'SFO',name:"San Francisco Int'l Airport",dist:21},'oak':{iata:'OAK',name:"Oakland Int'l Airport",dist:16},'sjc':{iata:'SJC',name:"San Jos√© Mineta Int'l Airport",dist:59}},
            'seattle':{'sea':{iata:'SEA',name:"Seattle-Tacoma Int'l Airport",dist:23}},
            'las vegas':{'las':{iata:'LAS',name:"Harry Reid Int'l Airport",dist:8}},
            'denver':{'den':{iata:'DEN',name:"Denver Int'l Airport",dist:38}},
            'phoenix':{'phx':{iata:'PHX',name:"Phoenix Sky Harbor Int'l Airport",dist:5}},
            'toronto':{'yyz':{iata:'YYZ',name:"Toronto Pearson Int'l Airport",dist:27},'yzd':{iata:'YYB',name:"North Bay Airport",dist:330}},
            'montreal':{'yul':{iata:'YUL',name:"Montr√©al-Trudeau Int'l Airport",dist:20}},
            'vancouver':{'yvr':{iata:'YVR',name:"Vancouver Int'l Airport",dist:14}},
            'mexico city':{'mex':{iata:'MEX',name:"Mexico City Int'l Airport",dist:13}},
            'sao paulo':{'gru':{iata:'GRU',name:"S√£o Paulo‚ÄìGuarulhos Int'l Airport",dist:30},'cgh':{iata:'CGH',name:"S√£o Paulo‚ÄìCongonhas Airport",dist:8}},
            'rio de janeiro':{'gig':{iata:'GIG',name:"Rio de Janeiro‚ÄìGale√£o Int'l Airport",dist:19},'sdu':{iata:'SDU',name:"Santos Dumont Airport",dist:2}},
            'buenos aires':{'eze':{iata:'EZE',name:"Ministro Pistarini Int'l Airport",dist:35},'aep':{iata:'AEP',name:"Aeroparque Jorge Newbery",dist:2}},
            'lima':{'lim':{iata:'LIM',name:"Jorge Ch√°vez Int'l Airport",dist:16}},
            'bogota':{'bog':{iata:'BOG',name:"El Dorado Int'l Airport",dist:15}},
            'santiago':{'scl':{iata:'SCL',name:"Arturo Merino Ben√≠tez Int'l Airport",dist:26}},
        };

        // Fuzzy match city name against IATA_DB keys
        function lookupIataDB(cityInput) {
            const q = cityInput.trim().toLowerCase();
            // Direct match
            if (IATA_DB[q]) return Object.values(IATA_DB[q]);
            // Partial match (city is contained in key or vice versa)
            for (const [key, val] of Object.entries(IATA_DB)) {
                if (q.includes(key) || key.includes(q)) return Object.values(val);
            }
            // Word-based partial match
            const words = q.split(/[\s,]+/).filter(w => w.length > 2);
            for (const [key, val] of Object.entries(IATA_DB)) {
                if (words.some(w => key.includes(w))) return Object.values(val);
            }
            return null;
        }

        // Overpass API ‚Äî search OpenStreetMap for aerodrome nodes near a city
        async function fetchAirportsViaOverpass(city, country) {
            // First geocode the city to get lat/lng
            const geoQuery = country ? `${city}, ${country}` : city;
            const geoUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(geoQuery)}&format=json&limit=1`;
            const geoRes = await fetch(geoUrl, { headers: { 'Accept-Language': 'en', 'User-Agent': 'SkyTrackPro/1.0' } });
            if (!geoRes.ok) throw new Error('Geocode failed');
            const geoData = await geoRes.json();
            if (!geoData.length) throw new Error('City not found');

            const lat = parseFloat(geoData[0].lat);
            const lon = parseFloat(geoData[0].lon);
            const r = 120000; // 120 km radius

            const overpassQuery = `[out:json][timeout:12];(node["aeroway"="aerodrome"]["iata"](around:${r},${lat},${lon});way["aeroway"="aerodrome"]["iata"](around:${r},${lat},${lon}););out center;`;
            const ovRes = await fetch('https://overpass-api.de/api/interpreter', {
                method: 'POST',
                body: 'data=' + encodeURIComponent(overpassQuery)
            });
            if (!ovRes.ok) throw new Error('Overpass failed');
            const ovData = await ovRes.json();

            if (!ovData.elements || ovData.elements.length === 0) throw new Error('No aerodrome data');

            // Compute distance from city center for sorting
            function haversine(lat1, lon1, lat2, lon2) {
                const R = 6371, dLat = (lat2-lat1)*Math.PI/180, dLon = (lon2-lon1)*Math.PI/180;
                const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
                return Math.round(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
            }

            const airports = ovData.elements
                .map(el => {
                    const elLat = el.lat || el.center?.lat;
                    const elLon = el.lon || el.center?.lon;
                    return {
                        iata: (el.tags.iata || '').toUpperCase().trim(),
                        name: el.tags.name || el.tags['name:en'] || (el.tags.iata + ' Airport'),
                        dist: haversine(lat, lon, elLat, elLon),
                        lat: elLat, lon: elLon
                    };
                })
                .filter(ap => ap.iata.length === 3)
                .sort((a, b) => a.dist - b.dist)
                .slice(0, 6);

            if (airports.length === 0) throw new Error('No IATA airports found');
            return airports;
        }

        // Main airport lookup: DB first, then Overpass
        async function fetchAirportsViaAI(city, country) {
            const cacheKey = (city + ',' + country).toLowerCase();
            if (_airportCache[cacheKey]) return _airportCache[cacheKey];

            // 1. Try built-in curated database (instant)
            const dbResult = lookupIataDB(city + (country ? ', ' + country : ''));
            if (!dbResult) {
                // Also try just city
            }
            const dbMatch = dbResult || lookupIataDB(city);
            if (dbMatch && dbMatch.length > 0) {
                _airportCache[cacheKey] = dbMatch;
                return dbMatch;
            }

            // 2. Try Overpass (OpenStreetMap) ‚Äî real airport data
            try {
                const ovAirports = await fetchAirportsViaOverpass(city, country);
                _airportCache[cacheKey] = ovAirports;
                return ovAirports;
            } catch(e) {
                console.warn('Overpass failed:', e.message);
            }

            // 3. Nothing found ‚Äî throw so caller shows the notice
            throw new Error('No airports found for ' + city);
        }




        async function fetchAirportsForSlot(slot) {
            const { city, country } = getSlotCityCountry(slot);
            if (!city) return;

            const wrap = document.getElementById(slot+'AirportWrap');
            const sel  = document.getElementById(slot+'AirportSelect');
            const warn = document.getElementById(slot+'AirportWarn');
            const chip = document.getElementById(slot+'AirportChip');
            if (!wrap) return;

            wrap.style.display = 'block';
            setAirportStatus(slot, `<span class="dot-spin"></span> <span style="color:var(--accent);font-weight:700;">AI</span> finding airports near <em>${city}</em>‚Ä¶`);
            sel.style.display = 'none';
            warn.classList.add('hidden');
            chip.innerHTML = '';
            window._selectedAirports[slot] = null;
            const cbox = document.getElementById(slot+'CustomBox');
            const ctog = wrap.querySelector('.custom-apt-toggle');
            if (cbox) cbox.classList.add('hidden');
            if (ctog) ctog.classList.remove('active');

            // ‚îÄ‚îÄ Multi-source airport lookup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            try {
                const airports = await fetchAirportsViaAI(city, country || '');
                renderAirportOptions(slot, airports, '<span style="color:#0284c7;font-size:0.68rem;margin-left:4px;"><i class="fas fa-database"></i> OSM</span>');
                return;
            } catch(lookupErr) {
                console.warn('Airport lookup failed:', lookupErr.message);
            }

            // ‚îÄ‚îÄ No airports found: show notice, do NOT auto-open custom ‚îÄ‚îÄ
            setAirportStatus(slot, '<i class="fas fa-info-circle" style="color:#f59e0b;"></i> <span style="color:#f59e0b;font-weight:700;">No airports found</span> for <em>' + city + '</em>');
            warn.innerHTML = '‚ö†Ô∏è <strong>No airports were found for this location.</strong> Please check: Is this city served by a commercial airport? If yes, use <em>"Enter Manually"</em> below to type the airport name and IATA code.';
            warn.classList.remove('hidden');
            // User must deliberately click "Enter Manually" if needed
        }
        function onAirportChange(slot) {
            const sel  = document.getElementById(slot+'AirportSelect');
            const chip = document.getElementById(slot+'AirportChip');
            const iata = sel.value;
            const name = sel.options[sel.selectedIndex]?.dataset.name || '';
            if (iata) {
                window._selectedAirports[slot] = { iata, name };
                chip.innerHTML = `<span class="airport-chip">‚úà ${iata} ‚Äî ${name}</span>`;
            } else {
                window._selectedAirports[slot] = null;
                chip.innerHTML = '';
            }
        }

        // ‚îÄ‚îÄ Custom airport toggle & confirm ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function toggleCustomAirport(slot) {
            const box  = document.getElementById(slot+'CustomBox');
            const wrap = document.getElementById(slot+'AirportWrap');
            const tog  = wrap ? wrap.querySelector('.custom-apt-toggle') : null;
            if (!box) return;
            const isOpen = !box.classList.contains('hidden');
            box.classList.toggle('hidden', isOpen);
            if (tog) tog.classList.toggle('active', !isOpen);
            if (!isOpen) {
                // Pre-fill from current selection
                const sel   = document.getElementById(slot+'AirportSelect');
                const codeI = document.getElementById(slot+'CustomCode');
                const nameI = document.getElementById(slot+'CustomName');
                if (sel && sel.value && codeI) codeI.value = sel.value;
                if (sel && sel.options[sel.selectedIndex]?.dataset.name && nameI) nameI.value = sel.options[sel.selectedIndex].dataset.name;
                if (codeI) codeI.focus();
            }
        }

        function confirmCustomAirport(slot) {
            const codeI = document.getElementById(slot+'CustomCode');
            const nameI = document.getElementById(slot+'CustomName');
            const chip  = document.getElementById(slot+'AirportChip');
            const box   = document.getElementById(slot+'CustomBox');
            const wrap  = document.getElementById(slot+'AirportWrap');
            const tog   = wrap ? wrap.querySelector('.custom-apt-toggle') : null;

            const iata = (codeI?.value||'').trim().toUpperCase();
            const name = (nameI?.value||'').trim();
            if (iata.length < 2) {
                if (codeI) { codeI.style.borderColor='#ef4444'; setTimeout(()=>codeI.style.borderColor='',1800); }
                return;
            }
            const displayName = name || iata + ' Airport';
            window._selectedAirports[slot] = { iata, name: displayName, custom: true };
            chip.innerHTML = `<span class="airport-chip airport-chip-custom">‚úè ${iata} ‚Äî ${displayName} <span style="opacity:0.78;font-size:0.6rem;">(custom)</span></span>`;
            setAirportStatus(slot, `<i class="fas fa-check-circle" style="color:#f59e0b;"></i> Custom airport set`);
            if (box) box.classList.add('hidden');
            if (tog) tog.classList.remove('active');
        }

        // Patch toggleTransit to reset transit airport wrap on hide
        const _origToggleTransit = toggleTransit;
        toggleTransit = function(show) {
            document.getElementById('transitFields').classList.toggle('hidden', !show);
            const tw = document.getElementById('transitAirportWrap');
            if (tw && !show) { tw.style.display='none'; window._selectedAirports['transit']=null; }
        };

        function payAndGenerate() {
    const name = document.getElementById('fullName').value;
    const email = localStorage.getItem('userEmail') || 'customer@skytrack.pro';

    if (!name) {
        showSkyModal({ icon: '‚ö†Ô∏è', iconColor:'#f59e0b', title:'Name Required', body:'<p>Please enter a passenger name before generating your ticket.</p>', buttons:[{label:'OK', cls:'modal-btn-primary', action:closeSkyModal}] });
        return;
    }

    const handler = PaystackPop.setup({
        key: 'pk_live_a7b2be34c6dd8f289f9b5aa09165b128088ccb02',
        email: email,
        amount: 50,
        currency: 'GHS',
        callback: function(response) {
            showSkyModal({ icon: 'üí≥', iconColor:'#22c55e', title:'Payment Successful!', body:`<p>Transaction confirmed.<br><small style="color:var(--text-dim);">Ref: ${response.reference}</small></p>`, buttons:[] });
            setTimeout(() => { closeSkyModal(); generateTicket(); }, 2500);
        },
        onClose: function() {
            showSkyModal({ icon: '‚ùå', iconColor:'#ef4444', title:'Payment Cancelled', body:'<p>You must complete payment to generate an elite SkyTrack ID.</p>', buttons:[{label:'Try Again', cls:'modal-btn-primary', action:()=>{ closeSkyModal(); payAndGenerate(); }},{label:'Not Now', cls:'modal-btn-ghost', action:closeSkyModal}] });
        }
    });
    handler.openIframe();
}

    </script>
</body>
</html>
