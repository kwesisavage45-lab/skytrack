<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkyTrack Pro | Elite Flight Intelligence</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Libre+Barcode+128&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --bg: #0f172a;
            --card: rgba(30, 41, 59, 0.7);
            --text: #f8fafc;
            --text-dim: #94a3b8;
            --accent: #38bdf8;
            --nav-bg: rgba(15, 23, 42, 0.9);
            --border: rgba(255, 255, 255, 0.1);
            --footer-bg: #0b1120;
        }

        [data-theme="light"] {
            --bg: #f8fafc;
            --card: rgba(255, 255, 255, 0.9);
            --text: #0f172a;
            --text-dim: #475569;
            --accent: #0284c7;
            --nav-bg: rgba(248, 250, 252, 0.9);
            --border: rgba(0, 0, 0, 0.1);
            --footer-bg: #e2e8f0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; transition: all 0.3s ease; }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            line-height: 1.6;
        }

        .hidden { display: none !important; }

        nav {
            position: fixed; top: 0; width: 100%; z-index: 2000;
            background: var(--nav-bg);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--border);
            padding: 1rem 8%;
            display: flex; justify-content: space-between; align-items: center;
        }

        .logo { font-size: 1.6rem; font-weight: 800; color: var(--accent); text-decoration: none; display: flex; align-items: center; gap: 10px; }
        .nav-content { display: flex; align-items: center; gap: 3rem; }
        .nav-links { display: flex; gap: 2.5rem; list-style: none; }
        .nav-links a { text-decoration: none; color: var(--text); font-weight: 500; font-size: 0.95rem; position: relative; padding: 5px 0; }
        .nav-links a::after { content: ''; position: absolute; bottom: 0; left: 0; width: 0; height: 2px; background: var(--accent); transition: width 0.3s ease; }
        .nav-links a:hover::after { width: 100%; }
        .nav-links a:hover { color: var(--accent); }
        .nav-actions { display: flex; align-items: center; gap: 1.5rem; }

        .btn-auth {
            background: var(--accent);
            color: #fff;
            padding: 0.7rem 1.5rem;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 15px rgba(56, 189, 248, 0.3);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-auth:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(56, 189, 248, 0.5); }

        #theme-toggle { background: none; border: none; color: var(--text); cursor: pointer; font-size: 1.3rem; }

        section { min-height: 100vh; padding: 100px 8% 60px; display: flex; flex-direction: column; }
        .hero { justify-content: center; align-items: center; text-align: center; }
        .hero h1 { font-size: clamp(2.2rem, 6vw, 4.5rem); font-weight: 800; line-height: 1.1; margin-bottom: 1.5rem; }
        .hero h1 span { color: var(--accent); }
        .hero p { font-size: 1.1rem; color: var(--text-dim); max-width: 700px; margin-bottom: 2.5rem; }

        .hero-btn-group {
            display: flex; gap: 12px; justify-content: center;
            width: 100%; max-width: 420px; margin: 0 auto;
        }
        .hero-btn-group .btn-auth { flex: 1; white-space: nowrap; padding: 1rem 1.2rem; }

        .dashboard-container { max-width: 800px; margin: 0 auto; width: 100%; }
        .glass-card { background: var(--card); padding: 2rem; border-radius: 24px; border: 1px solid var(--border); backdrop-filter: blur(10px); }
        
        .history-section { margin-top: 30px; }
        .history-card { background: var(--card); padding: 1rem; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .history-info { display: flex; flex-direction: column; }
        .history-id { color: var(--accent); font-weight: 800; font-size: 0.9rem; }
        .history-route { font-size: 0.8rem; font-weight: 600; }

        .trip-type-selector { display: flex; gap: 15px; margin-bottom: 20px; }
        .radio-group { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; cursor: pointer; }
        
        .grid-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .input-group { display: flex; flex-direction: column; gap: 8px; text-align: left; }
        .input-group label { font-size: 0.8rem; font-weight: 600; color: var(--accent); }
        .input-group input, .input-group select { 
            padding: 12px; border-radius: 12px; border: 1px solid var(--border); 
            background: rgba(0,0,0,0.2); color: white; outline: none; width: 100%;
        }
        [data-theme="light"] .input-group input, [data-theme="light"] .input-group select { background: #fff; color: #000; }

        .time-wrapper { display: flex; gap: 8px; }
        .time-wrapper input { flex: 2; }
        .time-wrapper select { flex: 1; }

        .info-notice-box {
            margin-top: 20px; padding: 15px; border: 1px dashed var(--accent); background: rgba(56, 189, 248, 0.05);
            border-radius: 12px; display: flex; align-items: flex-start; gap: 12px; transform: skewX(-2deg);
        }
        .info-notice-box i { color: var(--accent); margin-top: 3px; font-size: 0.9rem; }
        .info-notice-box p { font-size: 0.8rem; line-height: 1.4; color: var(--text-dim); margin-bottom: 0; text-align: left; font-style: italic; }

        .ticket-wrapper { margin-top: 30px; animation: slideUp 0.5s ease; width: 100%; }
        .ticket-visual {
            width: 100%; max-width: 750px; margin: 0 auto; background: #fff; color: #1a1a1a; 
            border-radius: 20px; display: flex; overflow: hidden; box-shadow: 0 30px 60px rgba(0,0,0,0.4);
        }
        .ticket-main { flex: 2; padding: 30px; border-right: 2px dashed #e2e8f0; position: relative; }
        .ticket-stub { flex: 0.8; padding: 30px; background: #f8fafc; display: flex; flex-direction: column; justify-content: space-between; }
        
        .airline-branding { display: flex; align-items: center; gap: 15px; margin-bottom: 30px; }
        .airline-logo { height: 40px; width: 40px; object-fit: contain; }
        .airline-name { font-weight: 800; font-size: 1.4rem; letter-spacing: -1px; }

        .pass-row { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .pass-label { font-size: 0.65rem; color: #64748b; font-weight: 800; text-transform: uppercase; display: block; }
        .pass-val { font-size: 1.1rem; font-weight: 700; color: #0f172a; }
        .ticket-id-val { color: var(--accent); font-weight: 800; }
        .barcode { font-family: 'Libre Barcode 128', cursive; font-size: 3rem; margin-top: 10px; }

        footer { background: var(--footer-bg); padding: 5rem 8% 2rem; border-top: 1px solid var(--border); }
        .footer-container { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 4rem; margin-bottom: 4rem; }
        .footer-brand h2 { color: var(--accent); margin-bottom: 1rem; font-weight: 800; }
        .footer-brand p { color: var(--text-dim); font-size: 0.9rem; max-width: 300px; }
        .footer-links h4 { color: var(--text); margin-bottom: 1.5rem; font-weight: 700; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px; }
        .footer-links ul { list-style: none; }
        .footer-links ul li { margin-bottom: 0.8rem; }
        .footer-links ul li a { text-decoration: none; color: var(--text-dim); font-size: 0.9rem; }
        .footer-links ul li a:hover { color: var(--accent); }
        .footer-bottom { padding-top: 2rem; border-top: 1px solid var(--border); text-align: center; font-size: 0.85rem; color: var(--text-dim); }

        .mobile-toggle { display: none; font-size: 1.5rem; cursor: pointer; }

        @media (max-width: 768px) {
            nav { padding: 1rem 5%; }
            .nav-content { 
                position: fixed; top: 70px; left: -100%; width: 100%; height: calc(100vh - 70px); 
                background: var(--nav-bg); flex-direction: column; justify-content: center; z-index: 1000; 
                transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); padding-bottom: 100px;
            }
            .nav-content.active { left: 0; }
            .nav-links { flex-direction: column; align-items: center; gap: 2rem; }
            .mobile-toggle { display: block; }
            section { padding: 100px 5% 40px; }
            .ticket-visual { flex-direction: column; }
            .footer-container { grid-template-columns: 1fr; gap: 2rem; }
        }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .transit-toggle-row { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding: 14px; background: rgba(56,189,248,0.05); border: 1px dashed var(--border); border-radius: 12px; }
        .transit-toggle-row label { font-size: 0.85rem; font-weight: 600; color: var(--text); cursor: pointer; }
        .transit-toggle-row input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--accent); cursor: pointer; }
        .transit-fields { margin-bottom: 20px; animation: slideUp 0.3s ease; }
        .cancel-flight-btn { background: #ef4444 !important; }
        .cancel-flight-btn:hover { background: #dc2626 !important; box-shadow: 0 6px 20px rgba(239,68,68,0.4) !important; }

        /* ── Airport selector ── */
        .airport-selector-wrap { margin-top: 10px; }
        .airport-status { font-size: 0.75rem; color: var(--text-dim); display: flex; align-items: center; gap: 6px; min-height: 18px; margin-bottom: 5px; }
        .dot-spin { width:10px; height:10px; border:2px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:_spin 0.7s linear infinite; display:inline-block; flex-shrink:0; }
        @keyframes _spin { to { transform:rotate(360deg); } }
        .airport-select {
            width:100%; padding:11px 32px 11px 12px; border-radius:12px;
            border:1.5px solid var(--accent); background:rgba(56,189,248,0.07);
            color:var(--text); outline:none; font-size:0.85rem; font-weight:600;
            cursor:pointer; appearance:none;
            background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='11' height='11' viewBox='0 0 24 24' fill='none' stroke='%2338bdf8' stroke-width='3'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat:no-repeat; background-position:right 12px center;
        }
        [data-theme="light"] .airport-select { background-color:#f0f9ff; color:#0f172a; border-color:#0284c7; }
        .airport-select option { background:var(--bg); color:var(--text); padding:6px; }
        .airport-warn { font-size:0.73rem; color:#f59e0b; font-style:italic; margin-top:4px; }
        .airport-chip { display:inline-flex; align-items:center; gap:5px; background:var(--accent); color:#fff; font-size:0.68rem; font-weight:800; padding:3px 10px; border-radius:20px; margin-top:5px; letter-spacing:1px; }

        /* ── Custom Airport Entry ── */
        .custom-apt-toggle {
            display:inline-flex; align-items:center; gap:5px;
            background:transparent; border:1.5px solid var(--accent);
            color:var(--accent); font-size:0.7rem; font-weight:700;
            padding:3px 10px; border-radius:20px; cursor:pointer;
            transition:all 0.2s; letter-spacing:0.3px;
        }
        .custom-apt-toggle:hover, .custom-apt-toggle.active {
            background:var(--accent); color:#fff;
        }
        .custom-apt-box {
            margin-top:10px; padding:14px; background:rgba(56,189,248,0.06);
            border:1.5px dashed var(--accent); border-radius:14px;
            animation: slideUp 0.25s ease;
        }
        .custom-apt-row {
            display:flex; align-items:flex-end; gap:10px; flex-wrap:wrap;
        }
        .custom-apt-row > div { display:flex; flex-direction:column; gap:5px; flex:1; min-width:80px; }
        .custom-apt-label { font-size:0.68rem; font-weight:700; color:var(--accent); text-transform:uppercase; letter-spacing:0.8px; }
        .custom-apt-input {
            padding:9px 11px; border-radius:10px; border:1.5px solid var(--border);
            background:rgba(0,0,0,0.12); color:var(--text); outline:none;
            font-size:0.85rem; font-family:inherit; width:100%;
            transition:border-color 0.2s;
        }
        [data-theme="light"] .custom-apt-input { background:#fff; color:#0f172a; }
        .custom-apt-input:focus { border-color:var(--accent); }
        .custom-apt-confirm {
            padding:9px 16px; background:var(--accent); color:#fff;
            border:none; border-radius:10px; font-weight:800; font-size:0.8rem;
            cursor:pointer; white-space:nowrap; align-self:flex-end;
            transition:transform 0.15s, box-shadow 0.15s;
        }
        .custom-apt-confirm:hover { transform:translateY(-1px); box-shadow:0 4px 12px rgba(56,189,248,0.35); }
        .airport-chip-custom { background:#f59e0b !important; }
    </style>
</head>
<body>

    <nav>
        <a href="#" class="logo" onclick="toggleDashboard(false)">
            <i class="fas fa-paper-plane"></i> SkyTrack Pro
        </a>
        
        <div class="nav-content" id="navContent">
            <ul class="nav-links">
                <li><a href="#" onclick="toggleDashboard(false)">Home</a></li>
                <li><a href="about.html">About</a></li>
                <li><a href="contact.html">Contact</a></li>
                <li><a href="track.html">Live Tracker</a></li>
            </ul>
            <div class="nav-actions">
                    <span id="navUserName" style="display:none; font-size:0.85rem; font-weight:700; color:var(--accent);"></span>
                    <button onclick="handleAuthClick()" class="btn-auth" id="navActionBtn">Get Started</button>
            </div>
        </div>

        <div style="display: flex; align-items: center; gap: 15px;">
            <button id="theme-toggle"><i class="fas fa-moon"></i></button>
            <i class="fas fa-bars mobile-toggle" id="menuBtn"></i>
        </div>
    </nav>

    <section class="hero" id="heroSection">
        <h1>Your Journey <br><span>In Real Time.</span></h1>
        <p>The definitive command center for high-fidelity transit monitoring. Generate identity assets through your SkyTrack ID, secure your terminal access, and oversee your simulated flight path in real-time. Track your journey like a pro.</p>
        <div class="hero-btn-group">
            <button onclick="toggleDashboard(true)" class="btn-auth">Create Ticket</button>
            <button onclick="trackPrompt()" class="btn-auth" style="background: transparent; border: 1px solid var(--accent); color: var(--text);">Track Flight</button>
        </div>
    </section>

    <section class="hidden" id="dashboardSection">
        <div class="dashboard-container">
            <button onclick="toggleDashboard(false)" style="background:none; border:none; color:var(--accent); cursor:pointer; margin-bottom:15px; font-weight:600;">
                <i class="fas fa-arrow-left"></i> Back to Home
            </button>
            
            <div class="glass-card">
                <h2 style="margin-bottom: 20px;">Flight Dashboard</h2>
                
                <div class="input-group" style="margin-bottom: 20px;">
                    <label>Passenger Full Name</label>
                    <input type="text" id="fullName" placeholder="e.g. Alexandra Reed">
                </div>

                <div class="trip-type-selector">
                    <label class="radio-group"><input type="radio" name="trip" value="one" checked onclick="toggleReturnDate(false)"> One-way</label>
                    <label class="radio-group"><input type="radio" name="trip" value="round" onclick="toggleReturnDate(true)"> Round Trip</label>
                </div>

                <!-- City + Country for map geocoding accuracy -->
                <div class="grid-inputs">
                    <div class="input-group">
                        <label>From — City</label>
                        <input type="text" id="fromCity" placeholder="e.g. London" oninput="scheduleAirportFetch('from')">
                    </div>
                    <div class="input-group">
                        <label>From — Country</label>
                        <input type="text" id="fromCountry" placeholder="e.g. United Kingdom" oninput="scheduleAirportFetch('from')">
                    </div>
                </div>
                <div class="input-group" id="fromAirportWrap" style="margin-bottom:16px; display:none;">
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:4px;">
                        <label style="margin-bottom:0;">Departure Airport</label>
                        <button type="button" class="custom-apt-toggle" onclick="toggleCustomAirport('from')">
                            <i class="fas fa-pen" style="font-size:0.65rem;"></i> Custom
                        </button>
                    </div>
                    <div class="airport-status" id="fromAirportStatus"></div>
                    <select class="airport-select" id="fromAirportSelect" onchange="onAirportChange('from')">
                        <option value="">— select airport —</option>
                    </select>
                    <div class="airport-warn hidden" id="fromAirportWarn"></div>
                    <div id="fromAirportChip"></div>
                    <!-- Custom Airport Entry -->
                    <div class="custom-apt-box hidden" id="fromCustomBox">
                        <div class="custom-apt-row">
                            <div>
                                <label class="custom-apt-label">IATA Code</label>
                                <input type="text" id="fromCustomCode" class="custom-apt-input" placeholder="e.g. LHR" maxlength="4" oninput="this.value=this.value.toUpperCase()">
                            </div>
                            <div style="flex:2;">
                                <label class="custom-apt-label">Airport Name</label>
                                <input type="text" id="fromCustomName" class="custom-apt-input" placeholder="e.g. Heathrow Airport">
                            </div>
                            <button type="button" class="custom-apt-confirm" onclick="confirmCustomAirport('from')">✓ Set</button>
                        </div>
                    </div>
                </div>

                <div class="grid-inputs">
                    <div class="input-group">
                        <label>To — City</label>
                        <input type="text" id="toCity" placeholder="e.g. New York" oninput="scheduleAirportFetch('to')">
                    </div>
                    <div class="input-group">
                        <label>To — Country</label>
                        <input type="text" id="toCountry" placeholder="e.g. United States" oninput="scheduleAirportFetch('to')">
                    </div>
                </div>
                <div class="input-group" id="toAirportWrap" style="margin-bottom:16px; display:none;">
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:4px;">
                        <label style="margin-bottom:0;">Arrival Airport</label>
                        <button type="button" class="custom-apt-toggle" onclick="toggleCustomAirport('to')">
                            <i class="fas fa-pen" style="font-size:0.65rem;"></i> Custom
                        </button>
                    </div>
                    <div class="airport-status" id="toAirportStatus"></div>
                    <select class="airport-select" id="toAirportSelect" onchange="onAirportChange('to')">
                        <option value="">— select airport —</option>
                    </select>
                    <div class="airport-warn hidden" id="toAirportWarn"></div>
                    <div id="toAirportChip"></div>
                    <div class="custom-apt-box hidden" id="toCustomBox">
                        <div class="custom-apt-row">
                            <div>
                                <label class="custom-apt-label">IATA Code</label>
                                <input type="text" id="toCustomCode" class="custom-apt-input" placeholder="e.g. JFK" maxlength="4" oninput="this.value=this.value.toUpperCase()">
                            </div>
                            <div style="flex:2;">
                                <label class="custom-apt-label">Airport Name</label>
                                <input type="text" id="toCustomName" class="custom-apt-input" placeholder="e.g. JFK International">
                            </div>
                            <button type="button" class="custom-apt-confirm" onclick="confirmCustomAirport('to')">✓ Set</button>
                        </div>
                    </div>
                </div>

                <div class="grid-inputs">
                    <div class="input-group">
                        <label>Departure Date</label>
                        <input type="date" id="travelDate">
                    </div>
                    <div class="input-group">
                        <label>Departure Time</label>
                        <div class="time-wrapper">
                            <input type="text" id="depTime" placeholder="HH:MM" maxlength="5" class="time-mask">
                            <select id="depAMPM"><option>AM</option><option>PM</option></select>
                        </div>
                    </div>
                </div>

                <div class="grid-inputs">
                    <div class="input-group">
                        <label>Estimated Arrival Time</label>
                        <div class="time-wrapper">
                            <input type="text" id="arrTime" placeholder="HH:MM" maxlength="5" class="time-mask">
                            <select id="arrAMPM"><option>AM</option><option>PM</option></select>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Flight Class</label>
                        <select id="flightClass">
                            <option value="Economy Class">Economy Class</option>
                            <option value="Basic Economy">Basic Economy</option>
                            <option value="Premium Economy">Premium Economy</option>
                            <option value="Business Class">Business Class</option>
                            <option value="First Class">First Class</option>
                        </select>
                    </div>
                </div>

                <div class="input-group" style="margin-bottom: 20px;">
                    <label>Airline</label>
                    <select id="airlineSelect" onchange="handleAirlineChange(this.value)">
                        <option value="Delta Air Lines">Delta Air Lines</option>
                        <option value="Emirates">Emirates</option>
                        <option value="Qatar Airways">Qatar Airways</option>
                        <option value="Lufthansa">Lufthansa</option>
                        <option value="British Airways">British Airways</option>
                        <option value="custom">Other (Input Custom)</option>
                    </select>
                    <input type="text" id="customAirline" class="hidden" placeholder="Enter Airline Name" style="margin-top:10px;">
                </div>

                <div id="returnGroup" class="input-group hidden" style="margin-bottom: 20px;">
                    <label>Return Date</label>
                    <input type="date" id="returnDate">
                </div>

                <!-- Transit Section -->
                <div class="transit-toggle-row">
                    <input type="checkbox" id="hasTransit" onchange="toggleTransit(this.checked)">
                    <label for="hasTransit"><i class="fas fa-route" style="color:var(--accent); margin-right:6px;"></i> Will there be a transit stop in your travel?</label>
                </div>
                <div id="transitFields" class="transit-fields hidden">
                    <div class="grid-inputs">
                        <div class="input-group">
                            <label>Transit — City <span style="color:#ef4444;">*</span></label>
                            <input type="text" id="transitCity" placeholder="e.g. Dubai" oninput="scheduleAirportFetch('transit')">
                        </div>
                        <div class="input-group">
                            <label>Transit — Country <span style="color:#ef4444;">*</span></label>
                            <input type="text" id="transitCountry" placeholder="e.g. United Arab Emirates" oninput="scheduleAirportFetch('transit')">
                        </div>
                    </div>
                    <div class="input-group" id="transitAirportWrap" style="margin-bottom:16px; display:none;">
                        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:4px;">
                            <label style="margin-bottom:0;">Transit Airport</label>
                            <button type="button" class="custom-apt-toggle" onclick="toggleCustomAirport('transit')">
                                <i class="fas fa-pen" style="font-size:0.65rem;"></i> Custom
                            </button>
                        </div>
                        <div class="airport-status" id="transitAirportStatus"></div>
                        <select class="airport-select" id="transitAirportSelect" onchange="onAirportChange('transit')">
                            <option value="">— select airport —</option>
                        </select>
                        <div class="airport-warn hidden" id="transitAirportWarn"></div>
                        <div id="transitAirportChip"></div>
                        <div class="custom-apt-box hidden" id="transitCustomBox">
                            <div class="custom-apt-row">
                                <div>
                                    <label class="custom-apt-label">IATA Code</label>
                                    <input type="text" id="transitCustomCode" class="custom-apt-input" placeholder="e.g. DXB" maxlength="4" oninput="this.value=this.value.toUpperCase()">
                                </div>
                                <div style="flex:2;">
                                    <label class="custom-apt-label">Airport Name</label>
                                    <input type="text" id="transitCustomName" class="custom-apt-input" placeholder="e.g. Dubai International">
                                </div>
                                <button type="button" class="custom-apt-confirm" onclick="confirmCustomAirport('transit')">✓ Set</button>
                            </div>
                        </div>
                    </div>
                    <div class="grid-inputs">
                        <div class="input-group">
                            <label>Transit Arrival Time</label>
                            <div class="time-wrapper">
                                <input type="text" id="transitArrTime" placeholder="HH:MM" maxlength="5" class="time-mask">
                                <select id="transitArrAMPM"><option>AM</option><option>PM</option></select>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Transit Layover Duration</label>
                            <select id="transitDuration" onchange="handleLayoverChange(this.value)">
                                <option value="30">30 minutes</option>
                                <option value="45">45 minutes</option>
                                <option value="60">1 hour</option>
                                <option value="90">1.5 hours</option>
                                <option value="120" selected>2 hours</option>
                                <option value="180">3 hours</option>
                                <option value="240">4 hours</option>
                                <option value="300">5 hours</option>
                                <option value="360">6 hours</option>
                                <option value="custom">Custom time…</option>
                            </select>
                            <div id="customLayoverWrap" class="hidden" style="margin-top:10px; display:flex; gap:8px; align-items:center;">
                                <input type="number" id="customLayoverVal" placeholder="e.g. 90" min="1" style="flex:2; padding:12px; border-radius:12px; border:1px solid var(--border); background:rgba(0,0,0,0.2); color:white; outline:none;">
                                <select id="customLayoverUnit" style="flex:1; padding:12px; border-radius:12px; border:1px solid var(--border); background:rgba(0,0,0,0.2); color:white; outline:none;">
                                    <option value="minutes">min</option>
                                    <option value="hours">hrs</option>
                                </select>
                            </div>
                            <style>[data-theme="light"] #customLayoverWrap input,[data-theme="light"] #customLayoverWrap select{background:#fff;color:#000;}</style>
                        </div>
                    </div>
                </div>

                <button class="btn-auth" style="width: 100%; height: 50px;" onclick="generateTicket()">Generate Elite Ticket</button>

                <div class="info-notice-box">
                    <i class="fas fa-circle-info"></i>
                    <p>Please review the time intervals between both destinations before entering them for an accurate flight. Also make sure the destination names are correctly spelled to avoid errors. Generating a new ticket creates a fresh tracking session starting from 0% progress.</p>
                </div>
            </div>

            <div id="successArea" class="hidden ticket-wrapper">
                <div class="ticket-visual" id="ticketImage">
                    <div class="ticket-main">
                        <div class="airline-branding">
                            <img id="logoImg" src="" class="airline-logo">
                            <span id="displayAirline" class="airline-name">AIRLINE</span>
                        </div>
                        
                        <div class="pass-row">
                            <div><span class="pass-label">Passenger Name</span><div id="displayName" class="pass-val">---</div></div>
                            <div style="text-align: right;"><span class="pass-label">Flight Class</span><div class="pass-val" id="displayClass">---</div></div>
                        </div>

                        <div class="pass-row" style="margin: 30px 0;">
                            <div>
                                <span class="pass-label">From</span>
                                <div id="displayFrom" class="pass-val" style="font-size: 1.8rem; line-height:1.1;">---</div>
                                <div id="displayFromCountry" style="font-size:0.7rem; color:#64748b; font-weight:600; margin-top:2px;">---</div>
                                <div id="displayFromAirport" style="font-size:0.65rem; color:#0284c7; font-weight:800; margin-top:3px; letter-spacing:0.5px;"></div>
                            </div>
                            <div style="display:flex; align-items:center; color:var(--accent);"><i class="fas fa-plane fa-2x"></i></div>
                            <div style="text-align: right;">
                                <span class="pass-label">To</span>
                                <div id="displayTo" class="pass-val" style="font-size: 1.8rem; line-height:1.1;">---</div>
                                <div id="displayToCountry" style="font-size:0.7rem; color:#64748b; font-weight:600; margin-top:2px;">---</div>
                                <div id="displayToAirport" style="font-size:0.65rem; color:#0284c7; font-weight:800; margin-top:3px; letter-spacing:0.5px;"></div>
                            </div>
                        </div>

                        <div class="pass-row">
                            <div><span class="pass-label">Departure Date</span><div id="displayDate" class="pass-val">---</div></div>
                            <div><span class="pass-label">Gate / Terminal</span><div class="pass-val" id="displayGate">---</div></div>
                            <div style="text-align: right;"><span class="pass-label">Arrival Time</span><div class="pass-val" id="displayArrival">---</div></div>
                        </div>
                        <div id="transitRow" class="pass-row hidden" style="background:#f8fafc; border-radius:10px; padding:10px; border:1px dashed #cbd5e1;">
                            <div><span class="pass-label" style="color:#f59e0b;">✈ Via Transit</span><div id="displayTransit" class="pass-val" style="font-size:0.95rem; color:#0f172a;">---</div><div id="displayTransitAirport" style="font-size:0.65rem; color:#0284c7; font-weight:800; margin-top:2px;"></div></div>
                            <div style="text-align:right;"><span class="pass-label">Layover</span><div id="displayLayover" class="pass-val" style="font-size:0.95rem;">---</div></div>
                        </div>
                    </div>

                    <div class="ticket-stub">
                        <div>
                            <span class="pass-label">SkyTrack ID</span>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <div id="displayID" class="ticket-id-val">--</div>
                                <i class="fas fa-copy" onclick="copyOnlyID()" style="cursor: pointer; font-size: 0.8rem; color: var(--accent);"></i>
                            </div>
                        </div>
                        <div>
                            <span class="pass-label">Terminal</span>
                            <div id="stubTerminal" style="font-size: 0.8rem; font-weight: 700;">---</div>
                        </div>
                        <div>
                            <span class="pass-label">Airport Code</span>
                            <div id="stubAirportCode" style="font-size: 0.85rem; font-weight: 800; color:#0284c7; letter-spacing:1px;">---</div>
                        </div>
                        <div class="barcode">123456789</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; width: 100%;">
                    <button class="btn-auth" onclick="downloadPDF()"><i class="fas fa-file-pdf"></i> PDF</button>
                    <button class="btn-auth cancel-flight-btn" onclick="cancelFlight()"><i class="fas fa-times-circle"></i> Cancel Flight</button>
                </div>
                <button class="btn-auth" style="width: 100%; margin-top: 15px; background: #6366f1;" onclick="copyTrackingLink()">
                    <i class="fas fa-link"></i> Copy Tracking Link
                </button>
            </div>

            <div class="history-section" id="historyArea">
                <h3 style="margin: 20px 0 10px; color: var(--text-dim);">Flight History</h3>
                <div id="historyList"></div>
            </div>
        </div>
    </section>

    <footer>
        <div class="footer-container">
            <div class="footer-brand">
                <h2>SkyTrack Pro</h2>
                <p>Redefining how travelers share their journey. Secure, real-time, and built for the modern sky-dweller.</p>
            </div>
            <div class="footer-links">
                <h4>Navigation</h4>
                <ul>
                    <li><a href="#" onclick="toggleDashboard(false)">Home</a></li>
                    <li><a href="about.html">About Us</a></li>
                    <li><a href="contact.html">Contact</a></li>
                    <li><a href="track.html">Live Tracker</a></li>
                </ul>
            </div>
            <div class="footer-links">
                <h4>Resources</h4>
                <ul>
                    <li><a href="#">Flight API</a></li>
                    <li><a href="#">Travel Insights</a></li>
                    <li><a href="#">AeroData Logs</a></li>
                    <li><a href="#">Privacy Policy</a></li>
                </ul>
            </div>
            <div class="footer-links">
                <h4>Support</h4>
                <ul>
                    <li><a href="contact.html">Help Center</a></li>
                    <li><a href="safety.html">Safety Guidelines</a></li>
                    <li><a href="contact.html">Technical Support</a></li>
                    <li><a href="safety.html">Terms of Service</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            &copy; 2026 SkyTrack Pro. Powered by Team OG. Built for global connectivity.
        </div>
    </footer>

    <!-- Firebase Auth + Firestore -->
    <script type="module">
        import { initializeApp }    from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, where, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

        const app = initializeApp({
            apiKey:            "AIzaSyAcnU7sDm8pWkWssgxMPA4q2rdpS8a6qDw",
            authDomain:        "skytrack-28c83.firebaseapp.com",
            projectId:         "skytrack-28c83",
            storageBucket:     "skytrack-28c83.firebasestorage.app",
            messagingSenderId: "876231264024",
            appId:             "1:876231264024:web:eb42a685ee2bad2020c06d",
            measurementId:     "G-FE2WV6KZ20"
        });
        const auth = getAuth(app);
        const db   = getFirestore(app);

        // Expose Firestore helpers globally so non-module scripts can call them
        window._db = db;
        window._fsSetFlight = async (id, data) => {
            await setDoc(doc(db, 'flights', id), data);
        };
        window._fsGetFlight = async (id) => {
            const snap = await getDoc(doc(db, 'flights', id));
            return snap.exists() ? snap.data() : null;
        };
        window._fsUpdateFlight = async (id, fields) => {
            await updateDoc(doc(db, 'flights', id), fields);
        };
        window._fsGetUserFlights = async (uid) => {
            const q = query(
                collection(db, 'flights'),
                where('uid', '==', uid),
                orderBy('createdAt', 'desc'),
                limit(5)
            );
            const snap = await getDocs(q);
            return snap.docs.map(d => d.data());
        };

        onAuthStateChanged(auth, user => {
            if(user){
                localStorage.setItem('isLoggedIn','true');
                localStorage.setItem('userEmail', user.email||'');
                localStorage.setItem('userName',  user.displayName||'');
                localStorage.setItem('uid', user.uid);
            } else {
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('userName');
                localStorage.removeItem('uid');
            }
            window._fbAuth    = auth;
            window._fbSignOut = signOut;
            window._fbReady   = true;
            updateNavUI(!!user);
        });
    </script>

    <script>
        function updateNavUI(loggedIn){
            const navBtn  = document.getElementById('navActionBtn');
            const nameTag = document.getElementById('navUserName');
            const userName= localStorage.getItem('userName') || localStorage.getItem('userEmail') || '';
            if(loggedIn){
                navBtn.innerHTML  = '<i class="fas fa-sign-out-alt"></i> Log Out';
                navBtn.style.background = '#ef4444';
                if(nameTag && userName){ nameTag.textContent = 'Hi, ' + userName.split(' ')[0]; nameTag.style.display='inline'; }
                loadHistory();
            } else {
                navBtn.innerHTML  = 'Get Started';
                navBtn.style.background = 'var(--accent)';
                if(nameTag) nameTag.style.display='none';
            }
        }

        function checkAuth(){
            return localStorage.getItem('isLoggedIn') === 'true';
        }

        function handleAuthClick(){
            if(checkAuth()){
                const doLogout = ()=>{
                    localStorage.removeItem('isLoggedIn');
                    localStorage.removeItem('userEmail');
                    localStorage.removeItem('userName');
                    window.location.reload();
                };
                if(window._fbAuth && window._fbSignOut){
                    window._fbSignOut(window._fbAuth).then(doLogout).catch(doLogout);
                } else { doLogout(); }
            } else {
                window.location.href = 'login.html';
            }
        }

        function toggleDashboard(show){
            if(show && !checkAuth()){
                window.location.href = 'login.html';
                return;
            }
            const hero = document.getElementById('heroSection');
            const dash = document.getElementById('dashboardSection');
            if(show){
                hero.classList.add('hidden');
                dash.classList.remove('hidden');
                window.scrollTo(0,0);
                loadHistory();
            } else {
                hero.classList.remove('hidden');
                dash.classList.add('hidden');
            }
        }

        window.addEventListener('DOMContentLoaded', ()=>{ updateNavUI(checkAuth()); });

        document.querySelectorAll('.time-mask').forEach(input => {
            input.addEventListener('input', (e) => {
                let val = e.target.value.replace(/\D/g, ''); 
                if (val.length > 2) { val = val.slice(0, 2) + ':' + val.slice(2, 4); }
                e.target.value = val;
            });
        });

        function toggleReturnDate(show) {
            document.getElementById('returnGroup').classList.toggle('hidden', !show);
        }

        function toggleTransit(show) {
            document.getElementById('transitFields').classList.toggle('hidden', !show);
        }

        function handleLayoverChange(val) {
            const wrap = document.getElementById('customLayoverWrap');
            wrap.classList.toggle('hidden', val !== 'custom');
            // Make the inner inputs visible in light mode too
            wrap.style.display = val === 'custom' ? 'flex' : 'none';
        }

        function handleAirlineChange(val) {
            const customInput = document.getElementById('customAirline');
            val === 'custom' ? customInput.classList.remove('hidden') : customInput.classList.add('hidden');
        }

        function trackPrompt() {
            const id = prompt("Enter the SkyTrack ID to view flight details:");
            if (id) { window.location.href = `track.html?id=${id.toUpperCase()}`; }
        }

        function generateTicket() {
            const name        = document.getElementById('fullName').value.trim();
            const fromCity    = document.getElementById('fromCity').value.trim();
            const fromCountry = document.getElementById('fromCountry').value.trim();
            const toCity      = document.getElementById('toCity').value.trim();
            const toCountry   = document.getElementById('toCountry').value.trim();

            // Full "City, Country" string — passed to map geocoder for accurate pin placement
            const from = fromCity + (fromCountry ? ', ' + fromCountry : '');
            const to   = toCity   + (toCountry   ? ', ' + toCountry   : '');

            const departDate  = document.getElementById('travelDate').value;
            const depTimeRaw  = document.getElementById('depTime').value;
            const depAMPM     = document.getElementById('depAMPM').value;
            const arrTimeRaw  = document.getElementById('arrTime').value;
            const arrAMPM     = document.getElementById('arrAMPM').value;
            const flightClass = document.getElementById('flightClass').value;
            let airline = document.getElementById('airlineSelect').value;
            if (airline === 'custom') airline = document.getElementById('customAirline').value;

            if (!name || !fromCity || !toCity || !departDate || !depTimeRaw || !arrTimeRaw || !airline) {
                alert("Please fill in all required fields");
                return;
            }

            // FIX 1 — Timezone-safe timestamps
            function getTimestamp(dateStr, timeStr, ampm) {
                let [hours, minutes] = timeStr.split(':').map(Number);
                if (ampm === 'PM' && hours < 12) hours += 12;
                if (ampm === 'AM' && hours === 12) hours = 0;
                const [year, month, day] = dateStr.split('-').map(Number);
                return new Date(year, month - 1, day, hours, minutes, 0, 0).getTime();
            }

            const depTS = getTimestamp(departDate, depTimeRaw, depAMPM);
            let   arrTS = getTimestamp(departDate, arrTimeRaw, arrAMPM);
            if (arrTS <= depTS) arrTS += 24 * 60 * 60 * 1000;

            // Transit validation
            const hasTransit = document.getElementById('hasTransit').checked;
            let transitCity = '', transitCountry = '', transitDurationMins = 0, transitArrTS = 0;
            if (hasTransit) {
                transitCity    = document.getElementById('transitCity').value.trim();
                transitCountry = document.getElementById('transitCountry').value.trim();
                const transitArrRaw  = document.getElementById('transitArrTime').value;
                const transitArrAMPM = document.getElementById('transitArrAMPM').value;
                transitDurationMins  = parseInt(document.getElementById('transitDuration').value);
                if (isNaN(transitDurationMins) || document.getElementById('transitDuration').value === 'custom') {
                    const customVal  = parseFloat(document.getElementById('customLayoverVal').value);
                    const customUnit = document.getElementById('customLayoverUnit').value;
                    if (!customVal || customVal <= 0) {
                        alert("Please enter a valid custom layover duration.");
                        return;
                    }
                    transitDurationMins = customUnit === 'hours' ? Math.round(customVal * 60) : Math.round(customVal);
                }
                if (!transitCity || !transitCountry) {
                    alert("Please enter the transit city and country.");
                    return;
                }
                transitArrTS = getTimestamp(departDate, transitArrRaw || depTimeRaw, transitArrRaw ? transitArrAMPM : depAMPM);
                if (transitArrTS <= depTS) transitArrTS += 24 * 60 * 60 * 1000;
            }

            const id = "ST-" + Math.random().toString(36).substr(2, 5).toUpperCase();

            const flightData = {
                name:        name.toUpperCase(),
                from:        from.toUpperCase(),
                fromCity:    fromCity.toUpperCase(),
                fromCountry: fromCountry.toUpperCase(),
                to:          to.toUpperCase(),
                toCity:      toCity.toUpperCase(),
                toCountry:   toCountry.toUpperCase(),
                date:        departDate,
                dep:         depTimeRaw + " " + depAMPM,
                arr:         arrTimeRaw + " " + arrAMPM,
                departTime:  depTS,
                arrivalTime: arrTS,
                terminal:    ["T1", "T2", "T3"][Math.floor(Math.random() * 3)],
                gate:        String.fromCharCode(65 + Math.floor(Math.random() * 6)) + Math.floor(Math.random() * 30 + 1),
                class:       flightClass,
                airline:     airline.toUpperCase(),
                id:          id,
                hasTransit:       hasTransit,
                transitCity:      hasTransit ? transitCity.toUpperCase() : '',
                transitCountry:   hasTransit ? transitCountry.toUpperCase() : '',
                transit:          hasTransit ? (transitCity + (transitCountry ? ', ' + transitCountry : '')).toUpperCase() : '',
                transitArrTime:   transitArrTS,
                transitDuration:  transitDurationMins,
                cancelled:        false,
                fromAirportCode:  (window._selectedAirports['from']?.iata || ''),
                fromAirportName:  (window._selectedAirports['from']?.name || ''),
                toAirportCode:    (window._selectedAirports['to']?.iata || ''),
                toAirportName:    (window._selectedAirports['to']?.name || ''),
                transitAirportCode: hasTransit ? (window._selectedAirports['transit']?.iata || '') : '',
                transitAirportName: hasTransit ? (window._selectedAirports['transit']?.name || '') : ''
            };

            // Save to Firestore (cloud) so shared links work on any device
            const uid = localStorage.getItem('uid') || 'anonymous';
            const firestoreData = { ...flightData, uid, createdAt: Date.now() };
            if (window._fsSetFlight) {
                window._fsSetFlight(id, firestoreData).catch(err => console.error('Firestore save error:', err));
            }
            // Also keep a local copy for instant access
            localStorage.setItem('flight_' + id, JSON.stringify(flightData));
            updateUserHistory(id, from.toUpperCase(), to.toUpperCase());

            // Store current ticket ID for cancel button
            window._currentTicketId = id;

            document.getElementById('displayName').innerText        = flightData.name;
            document.getElementById('displayFrom').innerText        = flightData.fromCity;
            document.getElementById('displayFromCountry').innerText = flightData.fromCountry;
            document.getElementById('displayTo').innerText          = flightData.toCity;
            document.getElementById('displayToCountry').innerText   = flightData.toCountry;
            document.getElementById('displayAirline').innerText     = flightData.airline;
            document.getElementById('displayID').innerText          = id;
            document.getElementById('displayDate').innerText        = departDate;
            document.getElementById('displayArrival').innerText     = flightData.arr;
            document.getElementById('displayGate').innerText        = flightData.gate + " / " + flightData.terminal;
            document.getElementById('displayClass').innerText       = flightClass;
            document.getElementById('stubTerminal').innerText       = flightData.terminal;

            // Airport code display
            const fromApt = flightData.fromAirportCode ? `✈ ${flightData.fromAirportCode} — ${flightData.fromAirportName}` : '';
            const toApt   = flightData.toAirportCode   ? `✈ ${flightData.toAirportCode} — ${flightData.toAirportName}`   : '';
            document.getElementById('displayFromAirport').innerText = fromApt;
            document.getElementById('displayToAirport').innerText   = toApt;
            document.getElementById('stubAirportCode').innerText    = flightData.fromAirportCode || '---';

            // Transit display
            if (hasTransit) {
                document.getElementById('displayTransit').innerText = flightData.transit;
                const dur = flightData.transitDuration;
                document.getElementById('displayLayover').innerText = dur >= 60 ? Math.floor(dur/60) + 'h ' + (dur%60 ? (dur%60)+'m' : '') : dur + 'm';
                document.getElementById('transitRow').classList.remove('hidden');
                const trApt = flightData.transitAirportCode ? `✈ ${flightData.transitAirportCode} — ${flightData.transitAirportName}` : '';
                document.getElementById('displayTransitAirport').innerText = trApt;
            } else {
                document.getElementById('transitRow').classList.add('hidden');
            }
            
            document.getElementById('successArea').classList.remove('hidden');
            document.getElementById('successArea').scrollIntoView({ behavior: 'smooth' });
        }

        function updateUserHistory(id, from, to) {
            let history = JSON.parse(localStorage.getItem('ticketHistory') || '[]');
            history.unshift({id, from, to, date: new Date().toLocaleDateString()});
            localStorage.setItem('ticketHistory', JSON.stringify(history.slice(0, 5)));
            loadHistory();
        }

        function cancelFlight() {
            const id = window._currentTicketId;
            if (!id) return;
            if (!confirm(`Are you sure you want to cancel flight ${id}? This action cannot be undone.`)) return;

            const key = 'flight_' + id;
            const data = JSON.parse(localStorage.getItem(key));
            if (data) {
                data.cancelled = true;
                localStorage.setItem(key, JSON.stringify(data));
            }

            // Update Firestore
            if (window._fsUpdateFlight) {
                window._fsUpdateFlight(id, { cancelled: true }).catch(err => console.error('Firestore cancel error:', err));
            }

            // Mark in history
            let history = JSON.parse(localStorage.getItem('ticketHistory') || '[]');
            history = history.map(h => h.id === id ? {...h, cancelled: true} : h);
            localStorage.setItem('ticketHistory', JSON.stringify(history));

            // Update button to show cancelled
            const btn = document.querySelector('.cancel-flight-btn');
            btn.innerHTML = '<i class="fas fa-ban"></i> FLIGHT CANCELLED';
            btn.disabled = true;
            btn.style.opacity = '0.6';
            btn.style.cursor = 'not-allowed';

            // Show cancelled overlay on ticket
            const ticketImg = document.getElementById('ticketImage');
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:absolute;inset:0;background:rgba(239,68,68,0.15);display:flex;align-items:center;justify-content:center;border-radius:20px;z-index:10;';
            overlay.innerHTML = '<div style="background:#ef4444;color:#fff;font-weight:900;font-size:2rem;padding:12px 32px;border-radius:12px;letter-spacing:4px;transform:rotate(-8deg);box-shadow:0 4px 20px rgba(239,68,68,0.5);">CANCELLED</div>';
            ticketImg.style.position = 'relative';
            ticketImg.appendChild(overlay);

            loadHistory();
        }

        async function loadHistory() {
            const list = document.getElementById('historyList');
            if (!list) return;

            // Try Firestore first (cloud history, works across devices)
            const uid = localStorage.getItem('uid');
            if (uid && window._fsGetUserFlights) {
                try {
                    const flights = await window._fsGetUserFlights(uid);
                    if (flights.length > 0) {
                        renderHistoryItems(list, flights.map(f => ({
                            id: f.id,
                            from: f.fromCity || f.from,
                            to: f.toCity || f.to,
                            cancelled: f.cancelled || false
                        })));
                        return;
                    }
                } catch(e) { /* fall through to localStorage */ }
            }

            // Fallback: localStorage
            const history = JSON.parse(localStorage.getItem('ticketHistory') || '[]');
            renderHistoryItems(list, history);
        }

        function renderHistoryItems(list, history) {
            list.innerHTML = history.length ? '' : '<p style="font-size:0.8rem; color:var(--text-dim);">No previous tickets found.</p>';
            history.forEach(item => {
                const isCancelled = item.cancelled || false;
                list.innerHTML += `
                    <div class="history-card" style="${isCancelled ? 'opacity:0.6;' : ''}">
                        <div class="history-info">
                            <span class="history-id">${item.id}${isCancelled ? ' <span style="color:#ef4444;font-size:0.7rem;">✗ CANCELLED</span>' : ''}</span>
                            <span class="history-route">${item.from} <i class="fas fa-arrow-right" style="font-size:0.6rem;"></i> ${item.to}</span>
                        </div>
                        ${isCancelled ? '<span style="color:#ef4444;font-size:0.7rem;font-weight:800;">CANCELLED</span>' : `<button class="btn-auth" style="padding: 0.4rem 0.8rem; font-size: 0.7rem;" onclick="window.location.href='track.html?id=${item.id}'">Track</button>`}
                    </div>`;
            });
        }

        async function downloadPhoto() {
            const element = document.getElementById('ticketImage');
            const canvas = await html2canvas(element, { useCORS: true });
            const link = document.createElement('a');
            link.download = 'SkyTrack-Elite-Pass.png';
            link.href = canvas.toDataURL();
            link.click();
        }

        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const element = document.getElementById('ticketImage');
            const canvas = await html2canvas(element, { useCORS: true });
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('l', 'mm', [210, 100]);
            pdf.addImage(imgData, 'PNG', 0, 0, 210, 100);
            pdf.save("SkyTrack-Elite-Ticket.pdf");
        }

        function copyOnlyID() {
            const id = document.getElementById('displayID').innerText;
            navigator.clipboard.writeText(id);
            alert("ID Copied: " + id);
        }

        function copyTrackingLink() {
            const id   = document.getElementById('displayID').innerText;
            const base = window.location.href.replace(/\/[^/]*$/, '/');
            const link = base + 'track.html?id=' + id + '&share=1';
            navigator.clipboard.writeText(link).then(() => {
                const btn = document.querySelector('[onclick="copyTrackingLink()"]');
                const orig = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Link Copied!';
                btn.style.background = '#22c55e';
                setTimeout(() => { btn.innerHTML = orig; btn.style.background = '#6366f1'; }, 2500);
            }).catch(() => alert('Tracking link: ' + link));
        }        const themeBtn = document.getElementById('theme-toggle');
        const themeIcon = themeBtn.querySelector('i');
        const html = document.documentElement;

        themeBtn.addEventListener('click', () => {
            if (html.getAttribute('data-theme') === 'dark') {
                html.setAttribute('data-theme', 'light');
                themeIcon.className = 'fas fa-sun';
            } else {
                html.setAttribute('data-theme', 'dark');
                themeIcon.className = 'fas fa-moon';
            }
        });

        const menuBtn = document.getElementById('menuBtn');
        const navContent = document.getElementById('navContent');
        menuBtn.addEventListener('click', () => {
            navContent.classList.toggle('active');
            menuBtn.classList.toggle('fa-times');
        });

        // ══════════════════════════════════════════════════════════
        // ─── AIRPORT LOOKUP SYSTEM ────────────────────────────────
        // Tier 1: Overpass API (live, via OpenStreetMap)
        // Tier 2: Built-in offline DB of ~250 major airports (always works)
        // Tier 3: Smart city-name fallback
        // + Custom airport manual entry per slot
        // ══════════════════════════════════════════════════════════

        window._selectedAirports = { from: null, to: null, transit: null };
        const _airportTimers = {};

        // ── OFFLINE AIRPORT DATABASE ─────────────────────────────
        // 250+ major airports with IATA, name, lat, lng
        const AIRPORT_DB = [
            // UK / Ireland
            {iata:'LHR',name:'London Heathrow',lat:51.477,lng:-0.461,city:'London'},
            {iata:'LGW',name:'London Gatwick',lat:51.148,lng:-0.190,city:'London'},
            {iata:'STN',name:'London Stansted',lat:51.885,lng:0.235,city:'London'},
            {iata:'LTN',name:'London Luton',lat:51.875,lng:-0.368,city:'London'},
            {iata:'MAN',name:'Manchester Airport',lat:53.354,lng:-2.275,city:'Manchester'},
            {iata:'BHX',name:'Birmingham Airport',lat:52.454,lng:-1.748,city:'Birmingham'},
            {iata:'EDI',name:'Edinburgh Airport',lat:55.950,lng:-3.373,city:'Edinburgh'},
            {iata:'GLA',name:'Glasgow Airport',lat:55.872,lng:-4.433,city:'Glasgow'},
            {iata:'DUB',name:'Dublin Airport',lat:53.421,lng:-6.270,city:'Dublin'},
            {iata:'BRS',name:'Bristol Airport',lat:51.383,lng:-2.719,city:'Bristol'},
            {iata:'NCL',name:'Newcastle Airport',lat:55.038,lng:-1.692,city:'Newcastle'},
            {iata:'LBA',name:'Leeds Bradford Airport',lat:53.866,lng:-1.660,city:'Leeds'},
            // USA
            {iata:'ATL',name:'Hartsfield-Jackson Atlanta Intl',lat:33.641,lng:-84.427,city:'Atlanta'},
            {iata:'LAX',name:'Los Angeles Intl',lat:33.943,lng:-118.408,city:'Los Angeles'},
            {iata:'ORD',name:"O'Hare International",lat:41.979,lng:-87.905,city:'Chicago'},
            {iata:'DFW',name:'Dallas/Fort Worth Intl',lat:32.898,lng:-97.038,city:'Dallas'},
            {iata:'DEN',name:'Denver International',lat:39.856,lng:-104.674,city:'Denver'},
            {iata:'JFK',name:'John F. Kennedy Intl',lat:40.641,lng:-73.779,city:'New York'},
            {iata:'EWR',name:'Newark Liberty Intl',lat:40.693,lng:-74.169,city:'New York'},
            {iata:'LGA',name:'LaGuardia Airport',lat:40.777,lng:-73.873,city:'New York'},
            {iata:'SFO',name:'San Francisco Intl',lat:37.619,lng:-122.375,city:'San Francisco'},
            {iata:'SEA',name:'Seattle-Tacoma Intl',lat:47.450,lng:-122.309,city:'Seattle'},
            {iata:'MIA',name:'Miami International',lat:25.796,lng:-80.287,city:'Miami'},
            {iata:'MCO',name:'Orlando International',lat:28.431,lng:-81.308,city:'Orlando'},
            {iata:'IAH',name:'George Bush Intercontinental',lat:29.990,lng:-95.337,city:'Houston'},
            {iata:'HOU',name:'William P. Hobby Airport',lat:29.645,lng:-95.279,city:'Houston'},
            {iata:'PHX',name:'Phoenix Sky Harbor Intl',lat:33.437,lng:-112.008,city:'Phoenix'},
            {iata:'MSP',name:'Minneapolis-Saint Paul Intl',lat:44.881,lng:-93.222,city:'Minneapolis'},
            {iata:'DTW',name:'Detroit Metro Wayne County',lat:42.213,lng:-83.353,city:'Detroit'},
            {iata:'BOS',name:'Logan International',lat:42.364,lng:-71.006,city:'Boston'},
            {iata:'CLT',name:'Charlotte Douglas Intl',lat:35.214,lng:-80.944,city:'Charlotte'},
            {iata:'LAS',name:'Harry Reid International',lat:36.084,lng:-115.153,city:'Las Vegas'},
            {iata:'BWI',name:'Baltimore/Washington Intl',lat:39.175,lng:-76.669,city:'Baltimore'},
            {iata:'IAD',name:'Washington Dulles Intl',lat:38.945,lng:-77.456,city:'Washington DC'},
            {iata:'DCA',name:'Ronald Reagan Washington Natl',lat:38.852,lng:-77.038,city:'Washington DC'},
            {iata:'MDW',name:'Chicago Midway',lat:41.786,lng:-87.742,city:'Chicago'},
            {iata:'SAN',name:'San Diego International',lat:32.734,lng:-117.190,city:'San Diego'},
            {iata:'PDX',name:'Portland International',lat:45.589,lng:-122.593,city:'Portland'},
            {iata:'AUS',name:'Austin-Bergstrom Intl',lat:30.198,lng:-97.667,city:'Austin'},
            {iata:'MSY',name:'Louis Armstrong New Orleans Intl',lat:29.993,lng:-90.258,city:'New Orleans'},
            {iata:'PHL',name:'Philadelphia International',lat:39.872,lng:-75.241,city:'Philadelphia'},
            {iata:'SLC',name:'Salt Lake City International',lat:40.788,lng:-111.978,city:'Salt Lake City'},
            {iata:'RDU',name:'Raleigh-Durham International',lat:35.877,lng:-78.787,city:'Raleigh'},
            {iata:'TPA',name:'Tampa International',lat:27.975,lng:-82.533,city:'Tampa'},
            {iata:'STL',name:'St. Louis Lambert International',lat:38.748,lng:-90.370,city:'St. Louis'},
            // Canada
            {iata:'YYZ',name:'Toronto Pearson International',lat:43.681,lng:-79.614,city:'Toronto'},
            {iata:'YVR',name:'Vancouver International',lat:49.195,lng:-123.180,city:'Vancouver'},
            {iata:'YUL',name:'Montréal-Trudeau International',lat:45.470,lng:-73.741,city:'Montreal'},
            {iata:'YYC',name:'Calgary International',lat:51.131,lng:-114.011,city:'Calgary'},
            {iata:'YOW',name:'Ottawa Macdonald-Cartier Intl',lat:45.324,lng:-75.669,city:'Ottawa'},
            {iata:'YEG',name:'Edmonton International',lat:53.310,lng:-113.580,city:'Edmonton'},
            {iata:'YHZ',name:'Halifax Stanfield International',lat:44.882,lng:-63.511,city:'Halifax'},
            // Europe
            {iata:'CDG',name:'Paris Charles de Gaulle',lat:49.009,lng:2.548,city:'Paris'},
            {iata:'ORY',name:'Paris Orly',lat:48.723,lng:2.380,city:'Paris'},
            {iata:'FRA',name:'Frankfurt Airport',lat:50.037,lng:8.562,city:'Frankfurt'},
            {iata:'AMS',name:'Amsterdam Schiphol',lat:52.310,lng:4.768,city:'Amsterdam'},
            {iata:'MAD',name:'Adolfo Suárez Madrid-Barajas',lat:40.472,lng:-3.561,city:'Madrid'},
            {iata:'BCN',name:'Barcelona El Prat',lat:41.297,lng:2.083,city:'Barcelona'},
            {iata:'FCO',name:'Rome Fiumicino',lat:41.800,lng:12.239,city:'Rome'},
            {iata:'MXP',name:'Milan Malpensa',lat:45.631,lng:8.723,city:'Milan'},
            {iata:'LIN',name:'Milan Linate',lat:45.445,lng:9.277,city:'Milan'},
            {iata:'MUC',name:'Munich Airport',lat:48.354,lng:11.786,city:'Munich'},
            {iata:'ZRH',name:'Zurich Airport',lat:47.464,lng:8.549,city:'Zurich'},
            {iata:'VIE',name:'Vienna International',lat:48.110,lng:16.570,city:'Vienna'},
            {iata:'BRU',name:'Brussels Airport',lat:50.901,lng:4.484,city:'Brussels'},
            {iata:'CPH',name:'Copenhagen Airport',lat:55.618,lng:12.656,city:'Copenhagen'},
            {iata:'ARN',name:'Stockholm Arlanda',lat:59.652,lng:17.919,city:'Stockholm'},
            {iata:'OSL',name:'Oslo Gardermoen',lat:60.194,lng:11.100,city:'Oslo'},
            {iata:'HEL',name:'Helsinki-Vantaa',lat:60.318,lng:24.963,city:'Helsinki'},
            {iata:'LIS',name:'Lisbon Humberto Delgado',lat:38.774,lng:-9.134,city:'Lisbon'},
            {iata:'ATH',name:'Athens International',lat:37.937,lng:23.945,city:'Athens'},
            {iata:'WAW',name:'Warsaw Chopin',lat:52.166,lng:20.967,city:'Warsaw'},
            {iata:'PRG',name:'Václav Havel Prague Airport',lat:50.100,lng:14.260,city:'Prague'},
            {iata:'BUD',name:'Budapest Ferenc Liszt Intl',lat:47.437,lng:19.261,city:'Budapest'},
            {iata:'OTP',name:'Henri Coandă International',lat:44.572,lng:26.102,city:'Bucharest'},
            {iata:'SOF',name:'Sofia Airport',lat:42.695,lng:23.411,city:'Sofia'},
            {iata:'DUB',name:'Dublin Airport',lat:53.421,lng:-6.270,city:'Dublin'},
            {iata:'KEF',name:'Keflavík International',lat:63.985,lng:-22.606,city:'Reykjavik'},
            {iata:'TXL',name:'Berlin Tegel (historical)',lat:52.560,lng:13.288,city:'Berlin'},
            {iata:'BER',name:'Berlin Brandenburg',lat:52.367,lng:13.503,city:'Berlin'},
            {iata:'GVA',name:'Geneva Airport',lat:46.238,lng:6.109,city:'Geneva'},
            {iata:'NCE',name:'Nice Côte d\'Azur',lat:43.665,lng:7.215,city:'Nice'},
            {iata:'PMI',name:'Palma de Mallorca',lat:39.551,lng:2.739,city:'Palma'},
            // Middle East
            {iata:'DXB',name:'Dubai International',lat:25.253,lng:55.366,city:'Dubai'},
            {iata:'DWC',name:'Al Maktoum International',lat:24.896,lng:55.161,city:'Dubai'},
            {iata:'AUH',name:'Abu Dhabi International',lat:24.443,lng:54.651,city:'Abu Dhabi'},
            {iata:'DOH',name:'Hamad International',lat:25.274,lng:51.608,city:'Doha'},
            {iata:'BAH',name:'Bahrain International',lat:26.271,lng:50.634,city:'Manama'},
            {iata:'KWI',name:'Kuwait International',lat:29.227,lng:47.969,city:'Kuwait City'},
            {iata:'RUH',name:'King Khalid International',lat:24.958,lng:46.699,city:'Riyadh'},
            {iata:'JED',name:'King Abdulaziz International',lat:21.680,lng:39.157,city:'Jeddah'},
            {iata:'MCT',name:'Muscat International',lat:23.593,lng:58.285,city:'Muscat'},
            {iata:'AMM',name:'Queen Alia International',lat:31.723,lng:35.993,city:'Amman'},
            {iata:'BEY',name:'Rafic Hariri International',lat:33.821,lng:35.488,city:'Beirut'},
            {iata:'TLV',name:'Ben Gurion International',lat:32.011,lng:34.887,city:'Tel Aviv'},
            {iata:'IST',name:'Istanbul Airport',lat:41.275,lng:28.752,city:'Istanbul'},
            {iata:'SAW',name:'Sabiha Gökçen International',lat:40.898,lng:29.309,city:'Istanbul'},
            {iata:'ESB',name:'Ankara Esenboğa',lat:40.128,lng:32.995,city:'Ankara'},
            // Africa
            {iata:'ACC',name:'Kotoka International',lat:5.605,lng:-0.167,city:'Accra'},
            {iata:'JNB',name:'O.R. Tambo International',lat:-26.134,lng:28.242,city:'Johannesburg'},
            {iata:'CPT',name:'Cape Town International',lat:-33.965,lng:18.602,city:'Cape Town'},
            {iata:'DUR',name:'King Shaka International',lat:-29.615,lng:31.120,city:'Durban'},
            {iata:'NBO',name:'Jomo Kenyatta International',lat:-1.319,lng:36.928,city:'Nairobi'},
            {iata:'ADD',name:'Addis Ababa Bole International',lat:8.978,lng:38.799,city:'Addis Ababa'},
            {iata:'LOS',name:'Murtala Muhammed International',lat:6.577,lng:3.321,city:'Lagos'},
            {iata:'ABV',name:'Nnamdi Azikiwe International',lat:9.006,lng:7.263,city:'Abuja'},
            {iata:'ABJ',name:'Félix-Houphouët-Boigny Intl',lat:5.261,lng:-3.926,city:'Abidjan'},
            {iata:'DKR',name:'Blaise Diagne International',lat:14.670,lng:-17.073,city:'Dakar'},
            {iata:'CAI',name:'Cairo International',lat:30.122,lng:31.406,city:'Cairo'},
            {iata:'CMN',name:'Mohammed V International',lat:33.368,lng:-7.590,city:'Casablanca'},
            {iata:'RAK',name:'Marrakesh Menara',lat:31.607,lng:-8.036,city:'Marrakech'},
            {iata:'TUN',name:'Tunis-Carthage International',lat:36.851,lng:10.228,city:'Tunis'},
            {iata:'ALG',name:'Houari Boumediene Airport',lat:36.691,lng:3.215,city:'Algiers'},
            {iata:'TIP',name:'Tripoli International',lat:32.664,lng:13.159,city:'Tripoli'},
            {iata:'KRT',name:'Khartoum International',lat:15.590,lng:32.553,city:'Khartoum'},
            {iata:'DAR',name:'Julius Nyerere International',lat:-6.878,lng:39.202,city:'Dar es Salaam'},
            {iata:'EBB',name:'Entebbe International',lat:0.042,lng:32.443,city:'Kampala'},
            {iata:'KGL',name:'Kigali International',lat:-1.969,lng:30.139,city:'Kigali'},
            {iata:'LFW',name:'Lomé-Tokoin International',lat:6.166,lng:1.255,city:'Lomé'},
            {iata:'COO',name:'Cadjehoun Airport',lat:6.357,lng:2.385,city:'Cotonou'},
            {iata:'BKO',name:'Bamako-Sénou International',lat:12.534,lng:-7.950,city:'Bamako'},
            {iata:'OUA',name:'Ouagadougou Airport',lat:12.353,lng:-1.512,city:'Ouagadougou'},
            {iata:'SSG',name:'Malabo Airport',lat:3.756,lng:8.709,city:'Malabo'},
            {iata:'FIH',name:'N\'djili International',lat:-4.386,lng:15.445,city:'Kinshasa'},
            {iata:'LAD',name:'Quatro de Fevereiro International',lat:-8.858,lng:13.231,city:'Luanda'},
            {iata:'MPM',name:'Maputo International',lat:-25.921,lng:32.573,city:'Maputo'},
            {iata:'TNR',name:'Ivato International',lat:-18.797,lng:47.479,city:'Antananarivo'},
            {iata:'MRU',name:'Sir Seewoosagur Ramgoolam Intl',lat:-20.430,lng:57.684,city:'Mauritius'},
            // Asia - East
            {iata:'PEK',name:'Beijing Capital International',lat:40.080,lng:116.585,city:'Beijing'},
            {iata:'PKX',name:'Beijing Daxing International',lat:39.510,lng:116.411,city:'Beijing'},
            {iata:'PVG',name:'Shanghai Pudong International',lat:31.144,lng:121.805,city:'Shanghai'},
            {iata:'SHA',name:'Shanghai Hongqiao International',lat:31.198,lng:121.336,city:'Shanghai'},
            {iata:'CAN',name:'Guangzhou Baiyun International',lat:23.392,lng:113.299,city:'Guangzhou'},
            {iata:'CTU',name:'Chengdu Shuangliu International',lat:30.578,lng:103.947,city:'Chengdu'},
            {iata:'SZX',name:'Shenzhen Bao\'an International',lat:22.639,lng:113.810,city:'Shenzhen'},
            {iata:'HKG',name:'Hong Kong International',lat:22.309,lng:113.915,city:'Hong Kong'},
            {iata:'ICN',name:'Incheon International',lat:37.469,lng:126.451,city:'Seoul'},
            {iata:'GMP',name:'Gimpo International',lat:37.559,lng:126.794,city:'Seoul'},
            {iata:'NRT',name:'Narita International',lat:35.765,lng:140.386,city:'Tokyo'},
            {iata:'HND',name:'Haneda Airport',lat:35.553,lng:139.781,city:'Tokyo'},
            {iata:'KIX',name:'Kansai International',lat:34.427,lng:135.244,city:'Osaka'},
            {iata:'ITM',name:'Osaka Itami Airport',lat:34.785,lng:135.438,city:'Osaka'},
            {iata:'CTS',name:'New Chitose Airport',lat:42.775,lng:141.693,city:'Sapporo'},
            {iata:'OKA',name:'Naha Airport',lat:26.195,lng:127.646,city:'Naha'},
            {iata:'TPE',name:'Taiwan Taoyuan International',lat:25.077,lng:121.232,city:'Taipei'},
            // Asia - South/SE
            {iata:'SIN',name:'Singapore Changi',lat:1.360,lng:103.989,city:'Singapore'},
            {iata:'BKK',name:'Suvarnabhumi International',lat:13.691,lng:100.750,city:'Bangkok'},
            {iata:'DMK',name:'Don Mueang International',lat:13.913,lng:100.607,city:'Bangkok'},
            {iata:'KUL',name:'Kuala Lumpur International',lat:2.745,lng:101.710,city:'Kuala Lumpur'},
            {iata:'CGK',name:'Soekarno–Hatta International',lat:-6.126,lng:106.656,city:'Jakarta'},
            {iata:'DPS',name:'Ngurah Rai International (Bali)',lat:-8.748,lng:115.167,city:'Bali'},
            {iata:'MNL',name:'Ninoy Aquino International',lat:14.509,lng:121.020,city:'Manila'},
            {iata:'SGN',name:'Tan Son Nhat International',lat:10.819,lng:106.652,city:'Ho Chi Minh City'},
            {iata:'HAN',name:'Noi Bai International',lat:21.221,lng:105.807,city:'Hanoi'},
            {iata:'RGN',name:'Yangon International',lat:16.907,lng:96.133,city:'Yangon'},
            {iata:'PNH',name:'Phnom Penh International',lat:11.547,lng:104.844,city:'Phnom Penh'},
            {iata:'VTE',name:'Wattay International',lat:17.988,lng:102.563,city:'Vientiane'},
            {iata:'DAC',name:'Hazrat Shahjalal International',lat:23.843,lng:90.398,city:'Dhaka'},
            {iata:'CMB',name:'Bandaranaike International',lat:7.181,lng:79.884,city:'Colombo'},
            {iata:'KTM',name:'Tribhuvan International',lat:27.697,lng:85.361,city:'Kathmandu'},
            {iata:'DEL',name:'Indira Gandhi International',lat:28.557,lng:77.101,city:'Delhi'},
            {iata:'BOM',name:'Chhatrapati Shivaji Maharaj Intl',lat:19.089,lng:72.868,city:'Mumbai'},
            {iata:'BLR',name:'Kempegowda International',lat:13.199,lng:77.706,city:'Bangalore'},
            {iata:'MAA',name:'Chennai International',lat:12.994,lng:80.178,city:'Chennai'},
            {iata:'CCU',name:'Netaji Subhas Chandra Bose Intl',lat:22.654,lng:88.447,city:'Kolkata'},
            {iata:'HYD',name:'Rajiv Gandhi International',lat:17.231,lng:78.430,city:'Hyderabad'},
            {iata:'AMD',name:'Sardar Vallabhbhai Patel Intl',lat:23.072,lng:72.634,city:'Ahmedabad'},
            {iata:'KHI',name:'Jinnah International',lat:24.906,lng:67.161,city:'Karachi'},
            {iata:'LHE',name:'Allama Iqbal International',lat:31.521,lng:74.404,city:'Lahore'},
            {iata:'ISB',name:'Islamabad International',lat:33.549,lng:72.826,city:'Islamabad'},
            {iata:'KBL',name:'Hamid Karzai International',lat:34.565,lng:69.212,city:'Kabul'},
            // Central Asia / Russia
            {iata:'SVO',name:'Sheremetyevo International',lat:55.973,lng:37.415,city:'Moscow'},
            {iata:'DME',name:'Domodedovo International',lat:55.409,lng:37.906,city:'Moscow'},
            {iata:'LED',name:'Pulkovo Airport',lat:59.800,lng:30.262,city:'St Petersburg'},
            {iata:'ALA',name:'Almaty International',lat:43.353,lng:77.040,city:'Almaty'},
            {iata:'NQZ',name:'Nursultan Nazarbayev Intl',lat:51.023,lng:71.467,city:'Astana'},
            {iata:'TAS',name:'Tashkent International',lat:41.258,lng:69.282,city:'Tashkent'},
            // Oceania
            {iata:'SYD',name:'Sydney Kingsford Smith',lat:-33.946,lng:151.177,city:'Sydney'},
            {iata:'MEL',name:'Melbourne Airport',lat:-37.673,lng:144.843,city:'Melbourne'},
            {iata:'BNE',name:'Brisbane Airport',lat:-27.384,lng:153.118,city:'Brisbane'},
            {iata:'PER',name:'Perth Airport',lat:-31.940,lng:115.967,city:'Perth'},
            {iata:'ADL',name:'Adelaide Airport',lat:-34.945,lng:138.531,city:'Adelaide'},
            {iata:'AKL',name:'Auckland Airport',lat:-37.009,lng:174.785,city:'Auckland'},
            {iata:'CHC',name:'Christchurch Airport',lat:-43.489,lng:172.532,city:'Christchurch'},
            {iata:'WLG',name:'Wellington Airport',lat:-41.327,lng:174.805,city:'Wellington'},
            {iata:'NAN',name:'Nadi International',lat:-17.755,lng:177.443,city:'Nadi'},
            // Latin America
            {iata:'GRU',name:'São Paulo/Guarulhos Intl',lat:-23.435,lng:-46.473,city:'São Paulo'},
            {iata:'GIG',name:'Rio de Janeiro/Galeão Intl',lat:-22.810,lng:-43.250,city:'Rio de Janeiro'},
            {iata:'BSB',name:'Brasília International',lat:-15.871,lng:-47.919,city:'Brasília'},
            {iata:'EZE',name:'Ezeiza International (Buenos Aires)',lat:-34.822,lng:-58.536,city:'Buenos Aires'},
            {iata:'AEP',name:'Aeroparque Jorge Newbery',lat:-34.559,lng:-58.416,city:'Buenos Aires'},
            {iata:'SCL',name:'Arturo Merino Benítez Intl',lat:-33.393,lng:-70.786,city:'Santiago'},
            {iata:'BOG',name:'El Dorado International',lat:4.702,lng:-74.147,city:'Bogotá'},
            {iata:'MDE',name:'José María Córdova Intl',lat:6.165,lng:-75.423,city:'Medellín'},
            {iata:'LIM',name:'Jorge Chávez International',lat:-12.022,lng:-77.115,city:'Lima'},
            {iata:'UIO',name:'Mariscal Sucre International',lat:-0.129,lng:-78.356,city:'Quito'},
            {iata:'GYE',name:'José Joaquín de Olmedo Intl',lat:-2.158,lng:-79.883,city:'Guayaquil'},
            {iata:'MVD',name:'Carrasco International',lat:-34.838,lng:-56.031,city:'Montevideo'},
            {iata:'ASU',name:'Silvio Pettirossi International',lat:-25.240,lng:-57.520,city:'Asunción'},
            {iata:'MEX',name:'Mexico City International',lat:19.436,lng:-99.072,city:'Mexico City'},
            {iata:'CUN',name:'Cancún International',lat:21.037,lng:-86.877,city:'Cancún'},
            {iata:'GDL',name:'Miguel Hidalgo y Costilla Intl',lat:20.521,lng:-103.311,city:'Guadalajara'},
            {iata:'HAV',name:'José Martí International',lat:22.989,lng:-82.410,city:'Havana'},
            {iata:'PTY',name:'Tocumen International',lat:9.071,lng:-79.384,city:'Panama City'},
            {iata:'MGA',name:'Augusto C. Sandino International',lat:12.142,lng:-86.168,city:'Managua'},
            {iata:'SAL',name:'El Salvador International',lat:13.441,lng:-89.056,city:'San Salvador'},
            {iata:'SJO',name:'Juan Santamaría International',lat:9.994,lng:-84.208,city:'San José'},
            {iata:'SDQ',name:'Las Américas International',lat:18.430,lng:-69.669,city:'Santo Domingo'},
            {iata:'SJU',name:'Luis Muñoz Marín International',lat:18.439,lng:-66.002,city:'San Juan'},
        ];

        function haversineKm(lat1,lon1,lat2,lon2){
            const R=6371, dLat=(lat2-lat1)*Math.PI/180, dLon=(lon2-lon1)*Math.PI/180;
            const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
        }

        /** Fuzzy city/country match against offline DB */
        function searchOfflineDB(city, country) {
            const norm = s => s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9 ]/g,'').trim();
            const cn = norm(city), co = norm(country);
            return AIRPORT_DB
                .map(ap => {
                    const ac = norm(ap.city || '');
                    let score = 0;
                    if (ac === cn)                        score += 100;
                    else if (ac.includes(cn)||cn.includes(ac)) score += 55;
                    const anm = norm(ap.name||'');
                    if (anm.includes(cn))                 score += 30;
                    // country bonus — helps when multiple cities match (e.g. many "Springfield"s)
                    const aco = norm(ap.country||'');
                    if (aco===co||aco.includes(co)||co.includes(aco)) score += 25;
                    return { ...ap, score, dist: 0 };
                })
                .filter(ap => ap.score >= 55)
                .sort((a,b) => b.score-a.score)
                .slice(0, 8);
        }

        function renderAirportOptions(slot, airports, label) {
            const sel  = document.getElementById(slot+'AirportSelect');
            const chip = document.getElementById(slot+'AirportChip');
            sel.innerHTML = '<option value="">— select airport —</option>';
            airports.forEach((ap, i) => {
                const opt = document.createElement('option');
                opt.value = ap.iata;
                opt.dataset.name = ap.name;
                opt.textContent = ap.dist > 0
                    ? `${ap.iata}  —  ${ap.name}  (${ap.dist} km away)`
                    : `${ap.iata}  —  ${ap.name}`;
                if (i===0) opt.selected = true;
                sel.appendChild(opt);
            });
            sel.style.display = 'block';
            window._selectedAirports[slot] = airports[0];
            chip.innerHTML = `<span class="airport-chip">✈ ${airports[0].iata} — ${airports[0].name}</span>`;
            setAirportStatus(slot, `<i class="fas fa-check-circle" style="color:#22c55e;"></i> ${airports.length} airport${airports.length>1?'s':''} found ${label}`);
        }

        // ── DEBOUNCE ──────────────────────────────────────────────
        function scheduleAirportFetch(slot) {
            clearTimeout(_airportTimers[slot]);
            _airportTimers[slot] = setTimeout(() => fetchAirportsForSlot(slot), 850);
        }

        function getSlotCityCountry(slot) {
            if (slot==='from')    return { city:document.getElementById('fromCity').value.trim(),    country:document.getElementById('fromCountry').value.trim() };
            if (slot==='to')      return { city:document.getElementById('toCity').value.trim(),      country:document.getElementById('toCountry').value.trim() };
            if (slot==='transit') return { city:document.getElementById('transitCity').value.trim(), country:document.getElementById('transitCountry').value.trim() };
        }

        function setAirportStatus(slot, html) {
            const el = document.getElementById(slot+'AirportStatus');
            if (el) el.innerHTML = html;
        }

        async function fetchAirportsForSlot(slot) {
            const { city, country } = getSlotCityCountry(slot);
            if (!city || !country) return;

            const wrap = document.getElementById(slot+'AirportWrap');
            const sel  = document.getElementById(slot+'AirportSelect');
            const warn = document.getElementById(slot+'AirportWarn');
            const chip = document.getElementById(slot+'AirportChip');
            if (!wrap) return;

            wrap.style.display = 'block';
            setAirportStatus(slot, `<span class="dot-spin"></span> Finding airports near ${city}…`);
            sel.style.display = 'none';
            warn.classList.add('hidden');
            chip.innerHTML = '';
            window._selectedAirports[slot] = null;
            // Collapse custom box on new search
            const cbox = document.getElementById(slot+'CustomBox');
            const ctog = wrap.querySelector('.custom-apt-toggle');
            if (cbox) cbox.classList.add('hidden');
            if (ctog) ctog.classList.remove('active');

            let lat = null, lng = null;

            // ── Layer 1: Nominatim geocode ────────────────────────
            try {
                const ctrl  = new AbortController();
                const timer = setTimeout(() => ctrl.abort(), 6000);
                const geoRes  = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(city+', '+country)}&format=json&limit=1`, { headers:{'Accept-Language':'en'}, signal:ctrl.signal });
                clearTimeout(timer);
                const geoData = await geoRes.json();
                if (geoData && geoData.length) { lat = parseFloat(geoData[0].lat); lng = parseFloat(geoData[0].lon); }
            } catch(e) { /* Nominatim failed — continue to offline */ }

            // ── Layer 2: Overpass (only if we have coords) ────────
            if (lat !== null) {
                try {
                    const q = `[out:json][timeout:12];(node["aeroway"="aerodrome"]["iata"](around:150000,${lat},${lng});way["aeroway"="aerodrome"]["iata"](around:150000,${lat},${lng});relation["aeroway"="aerodrome"]["iata"](around:150000,${lat},${lng}););out center tags;`;
                    const ctrl2  = new AbortController();
                    const timer2 = setTimeout(() => ctrl2.abort(), 8000);
                    const ovRes  = await fetch('https://overpass-api.de/api/interpreter', { method:'POST', body:'data='+encodeURIComponent(q), signal:ctrl2.signal });
                    clearTimeout(timer2);
                    const ovData = await ovRes.json();
                    const seen = new Set();
                    let airports = (ovData.elements||[])
                        .filter(el => el.tags && el.tags.iata)
                        .map(el => {
                            const elLat = el.lat ?? el.center?.lat ?? lat;
                            const elLng = el.lon ?? el.center?.lon ?? lng;
                            return { iata:el.tags.iata, name:el.tags.name||el.tags['name:en']||el.tags.iata, dist:Math.round(haversineKm(lat,lng,elLat,elLng)) };
                        })
                        .sort((a,b)=>a.dist-b.dist)
                        .filter(a=>{ if(seen.has(a.iata)) return false; seen.add(a.iata); return true; })
                        .slice(0,8);
                    if (airports.length > 0) { renderAirportOptions(slot, airports, ''); return; }
                } catch(e) { /* Overpass failed — fall through to offline DB */ }
            }

            // ── Layer 3: Offline DB — always succeeds ─────────────
            setAirportStatus(slot, `<span class="dot-spin"></span> Searching airport database…`);
            let offlineResults = [];

            if (lat !== null) {
                // If we have coords, sort entire DB by real distance from city
                offlineResults = AIRPORT_DB
                    .map(ap => ({ ...ap, dist: Math.round(haversineKm(lat, lng, ap.lat, ap.lng)) }))
                    .sort((a,b) => a.dist-b.dist)
                    .slice(0, 8);
            } else {
                // No coords — fuzzy match by city/country name
                offlineResults = searchOfflineDB(city, country);

                // Broader fallback: match anything in the country
                if (!offlineResults.length) {
                    const co = country.toLowerCase();
                    offlineResults = AIRPORT_DB
                        .filter(ap => (ap.country||'').toLowerCase().includes(co) || co.includes((ap.country||'').toLowerCase()))
                        .slice(0, 8);
                }

                // Ultimate fallback: return top global hubs
                if (!offlineResults.length) {
                    const hubs = ['LHR','JFK','DXB','SIN','FRA','CDG','HKG','LAX','NRT','DUB'];
                    offlineResults = AIRPORT_DB.filter(ap => hubs.includes(ap.iata));
                }
            }

            if (offlineResults.length > 0) {
                renderAirportOptions(slot, offlineResults, '<span style="color:#64748b;font-size:0.68rem;margin-left:4px;">(database)</span>');
            } else {
                // Absolute last case — auto-open custom entry
                setAirportStatus(slot, '');
                warn.textContent = 'No airports found. Use the Custom button to enter yours.';
                warn.classList.remove('hidden');
                if (cbox) cbox.classList.remove('hidden');
                if (ctog) ctog.classList.add('active');
            }
        }

        function onAirportChange(slot) {
            const sel  = document.getElementById(slot+'AirportSelect');
            const chip = document.getElementById(slot+'AirportChip');
            const iata = sel.value;
            const name = sel.options[sel.selectedIndex]?.dataset.name || '';
            if (iata) {
                window._selectedAirports[slot] = { iata, name };
                chip.innerHTML = `<span class="airport-chip">✈ ${iata} — ${name}</span>`;
            } else {
                window._selectedAirports[slot] = null;
                chip.innerHTML = '';
            }
        }

        // ── Custom airport toggle & confirm ───────────────────────
        function toggleCustomAirport(slot) {
            const box  = document.getElementById(slot+'CustomBox');
            const wrap = document.getElementById(slot+'AirportWrap');
            const tog  = wrap ? wrap.querySelector('.custom-apt-toggle') : null;
            if (!box) return;
            const isOpen = !box.classList.contains('hidden');
            box.classList.toggle('hidden', isOpen);
            if (tog) tog.classList.toggle('active', !isOpen);
            if (!isOpen) {
                // Pre-fill from current selection
                const sel   = document.getElementById(slot+'AirportSelect');
                const codeI = document.getElementById(slot+'CustomCode');
                const nameI = document.getElementById(slot+'CustomName');
                if (sel && sel.value && codeI) codeI.value = sel.value;
                if (sel && sel.options[sel.selectedIndex]?.dataset.name && nameI) nameI.value = sel.options[sel.selectedIndex].dataset.name;
                if (codeI) codeI.focus();
            }
        }

        function confirmCustomAirport(slot) {
            const codeI = document.getElementById(slot+'CustomCode');
            const nameI = document.getElementById(slot+'CustomName');
            const chip  = document.getElementById(slot+'AirportChip');
            const box   = document.getElementById(slot+'CustomBox');
            const wrap  = document.getElementById(slot+'AirportWrap');
            const tog   = wrap ? wrap.querySelector('.custom-apt-toggle') : null;

            const iata = (codeI?.value||'').trim().toUpperCase();
            const name = (nameI?.value||'').trim();
            if (iata.length < 2) {
                if (codeI) { codeI.style.borderColor='#ef4444'; setTimeout(()=>codeI.style.borderColor='',1800); }
                return;
            }
            const displayName = name || iata + ' Airport';
            window._selectedAirports[slot] = { iata, name: displayName, custom: true };
            chip.innerHTML = `<span class="airport-chip airport-chip-custom">✏ ${iata} — ${displayName} <span style="opacity:0.78;font-size:0.6rem;">(custom)</span></span>`;
            setAirportStatus(slot, `<i class="fas fa-check-circle" style="color:#f59e0b;"></i> Custom airport set`);
            if (box) box.classList.add('hidden');
            if (tog) tog.classList.remove('active');
        }

        // Patch toggleTransit to reset transit airport wrap on hide
        const _origToggleTransit = toggleTransit;
        toggleTransit = function(show) {
            document.getElementById('transitFields').classList.toggle('hidden', !show);
            const tw = document.getElementById('transitAirportWrap');
            if (tw && !show) { tw.style.display='none'; window._selectedAirports['transit']=null; }
        };
    </script>
</body>
</html>